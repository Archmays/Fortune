<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>„ÄêÂ§ßÂØåÁøÅ-100‰ª•ÂÜÖÂä†ÂáèÁâà„Äë</title>
    
    <!-- React & Tailwind -->
    <script crossorigin src="https://unpkg.com/react@18.2.0/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;700;900&display=swap');
        
        :root {
            --bg-dark: #0f172a;
            --panel-bg: #1e293b;
            --tile-bg: #ffffff;
        }

        body {
            font-family: 'Noto Sans SC', sans-serif;
            background-color: var(--bg-dark);
            color: #e2e8f0;
            overscroll-behavior: none;
            touch-action: manipulation;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
            height: 100vh;
            width: 100vw;
            overflow: hidden;
            margin: 0;
        }

        .app-container { display: flex; flex-direction: column; height: 100%; width: 100%; }

        @media (min-width: 1024px) {
            .app-container { flex-direction: row; padding: 24px; gap: 32px; }
            .board-section { flex: 2; height: 100%; border-radius: 24px; background: #111827; box-shadow: inset 0 0 40px rgba(0,0,0,0.6); padding: 20px; }
            .controls-section { flex: 1; max-width: 420px; display: flex; flex-direction: column; gap: 20px; }
            .mobile-hud { display: none !important; }
            .desktop-hud { display: flex !important; }
        }

        @media (max-width: 1023px) {
            .board-section { flex: 1; width: 100%; overflow: hidden; position: relative; display: flex; align-items: center; justify-content: center; padding-bottom: 140px; }
            .controls-section { display: none; }
            .mobile-hud { display: flex !important; }
            .desktop-hud { display: none !important; }
        }

        .board-grid {
            display: grid; gap: 4px; width: 100%;
            max-width: min(95vw, 600px); 
            background: var(--panel-bg); border: 4px solid var(--panel-bg); border-radius: 12px;
            position: relative; transition: all 0.3s ease;
        }
        @media (min-width: 1024px) { .board-grid { max-width: min(90vh, 850px); gap: 6px; border-width: 8px; border-radius: 20px; } }

        .tile {
            aspect-ratio: 1/1; background: var(--tile-bg); color: #1e293b;
            display: flex; flex-direction: column; align-items: center;
            border-radius: 4px; position: relative; overflow: visible;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }
        .tile.owned { border: 2px solid transparent; }
        
        .street-bar { width: 100%; height: 4px; flex-shrink: 0; opacity: 0.9; border-radius: 3px 3px 0 0; }
        .tile-idx { position: absolute; top: 1px; left: 2px; font-size: 8px; color: #94a3b8; font-weight: bold; opacity: 0.5; }
        .level-stars { position: absolute; top: 2px; right: 2px; font-size: 10px; color: #eab308; display: flex; gap: 0; z-index: 5; }

        .tile-content { flex: 1; width: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 2px; }
        .tile-icon-div { font-size: 20px; line-height: 1; margin-bottom: 2px; transition: all 0.3s; filter: drop-shadow(0 2px 2px rgba(0,0,0,0.1)); }
        .tile-name-div { font-weight: 700; width: 100%; text-align: center; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; font-size: 10px; margin-top: 1px; color: #334155; }
        .tile-price-div { background-color: #f1f5f9; border-radius: 4px; padding: 1px 6px; margin-top: 2px; font-family: monospace; color: #64748b; font-size: 12px; font-weight: 900; line-height: 1; }
        .tile-owner-div { margin-top: 2px; padding: 1px 4px; border-radius: 4px; color: white; font-weight: 700; font-size: 9px; box-shadow: 0 1px 2px rgba(0,0,0,0.1); line-height: 1.2; max-width: 95%; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        @media (min-width: 1024px) {
            .street-bar { height: 8px; }
            .tile-icon-div { font-size: 36px; margin-bottom: 6px; }
            .tile-name-div { font-size: 14px; margin-top: 2px; }
            .tile-price-div { font-size: 16px; padding: 2px 10px; }
            .tile-owner-div { font-size: 12px; padding: 3px 8px; }
        }

        .path-arrow { position: absolute; color: rgba(148, 163, 184, 0.4); font-size: 10px; pointer-events: none; z-index: 0; }
        .arrow-right { right: -6px; top: 50%; transform: translateY(-50%); }
        .arrow-left { left: -6px; top: 50%; transform: translateY(-50%); }
        .arrow-down { bottom: -8px; left: 50%; transform: translateX(-50%); font-size: 12px; }
        .return-start { position: absolute; bottom: 2px; width: 100%; text-align: center; font-size: 7px; color: #ef4444; font-weight: bold; background: rgba(255,255,255,0.9); pointer-events: none; z-index: 10; }

        .token { position: absolute; z-index: 50; display: flex; align-items: center; justify-content: center; transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1); pointer-events: none; }
        .token-body { width: 22px; height: 22px; border-radius: 50%; border: 2px solid #fff; box-shadow: 0 4px 8px rgba(0,0,0,0.4); display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 10px; background-size: cover; }
        .token-body.hopping { animation: jump 0.3s infinite alternate; }
        @keyframes jump { 0% { transform: translateY(0); } 100% { transform: translateY(-14px) scale(1.1); } }
        @media (min-width: 1024px) { .token-body { width: 40px; height: 40px; border-width: 4px; font-size: 18px; } }

        .float-text { position: absolute; top: -20px; left: 50%; transform: translateX(-50%); font-weight: 900; font-size: 18px; text-shadow: 0 2px 4px rgba(0,0,0,0.5); animation: floatUp 2s forwards; pointer-events: none; z-index: 100; white-space: nowrap; }
        @keyframes floatUp { 0% { opacity: 1; transform: translate(-50%, 0) scale(1); } 100% { opacity: 0; transform: translate(-50%, -50px) scale(1.2); } }

        /* Âú∞Âõæ‰∏äÁöÑÈöèÊú∫ÈáëÂ∏Å */
        .map-coin { position: absolute; top: 2px; left: 2px; font-size: 12px; animation: spin 2s infinite; z-index: 10; filter: drop-shadow(0 1px 2px rgba(0,0,0,0.3)); }
        @keyframes spin { 0% { transform: rotateY(0deg); } 100% { transform: rotateY(360deg); } }

        .mobile-hud { position: absolute; bottom: 0; left: 0; right: 0; background: rgba(30, 41, 59, 0.95); backdrop-filter: blur(12px); border-top: 1px solid rgba(255,255,255,0.1); padding: 10px 15px; padding-bottom: max(15px, env(safe-area-inset-bottom)); display: flex; flex-direction: column; gap: 10px; z-index: 60; box-shadow: 0 -4px 20px rgba(0,0,0,0.3); }
        .desktop-hud { height: 100%; background: var(--panel-bg); border-radius: 16px; padding: 24px; display: flex; flex-direction: column; gap: 24px; color: white; box-shadow: 0 4px 6px rgba(0,0,0,0.1); border: 1px solid rgba(255,255,255,0.05); }

        .dice-btn { background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%); border-radius: 16px; display: flex; align-items: center; justify-content: center; font-size: 32px; font-weight: 900; color: #0f172a; box-shadow: 0 6px 0 #94a3b8, 0 8px 15px rgba(0,0,0,0.2); transition: all 0.1s; cursor: pointer; }
        .dice-btn:active { transform: translateY(6px); box-shadow: 0 0 0 #94a3b8, inset 0 2px 5px rgba(0,0,0,0.1); }
        .dice-rolling { animation: dice-wobble 0.4s ease-in-out infinite; }
        @keyframes dice-wobble { 0%, 100% { transform: rotate(0deg) scale(1); } 25% { transform: rotate(-15deg) scale(1.1); } 75% { transform: rotate(15deg) scale(1.1); } }

        .player-card { background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 12px; padding: 12px; display: flex; align-items: center; gap: 12px; cursor: pointer; transition: all 0.2s; position: relative; }
        .player-card.active { background: rgba(59, 130, 246, 0.2); border-color: #3b82f6; box-shadow: 0 0 15px rgba(59, 130, 246, 0.2); }
        .player-card.bankrupt { opacity: 0.4; filter: grayscale(1); }
        .skill-badge { position: absolute; top: -5px; right: -5px; background: #eab308; color: #000; font-size: 8px; padding: 1px 4px; border-radius: 4px; font-weight: bold; }

        .pulse-text { animation: pulse 1.5s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; transform: scale(1); } 50% { opacity: 0.8; transform: scale(0.95); } }

        .no-scrollbar::-webkit-scrollbar { display: none; }
        .modal-bg { background: rgba(0,0,0,0.85); backdrop-filter: blur(4px); }
        .modal-content { animation: modalPop 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        @keyframes modalPop { from { opacity: 0; transform: scale(0.95) translateY(10px); } to { opacity: 1; transform: scale(1) translateY(0); } }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- Èü≥Êïà ---
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        const playTone = (freq, type, duration, vol = 0.1) => {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.type = type;
            osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
            gain.gain.setValueAtTime(vol, audioCtx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + duration);
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            osc.start();
            osc.stop(audioCtx.currentTime + duration);
        };
        const playSound = (effect, enabled) => {
            if (!enabled) return;
            switch(effect) {
                case 'dice': for(let i=0; i<6; i++) setTimeout(() => playTone(300+Math.random()*200, 'square', 0.05, 0.03), i*50); break;
                case 'step': playTone(400, 'sine', 0.08, 0.05); break;
                case 'coin': playTone(1000, 'sine', 0.1, 0.1); setTimeout(() => playTone(1500, 'sine', 0.2, 0.1), 100); break;
                case 'pay': playTone(200, 'sawtooth', 0.2, 0.05); setTimeout(() => playTone(150, 'sawtooth', 0.3, 0.05), 150); break;
                case 'upgrade': playTone(500, 'square', 0.1, 0.05); setTimeout(() => playTone(750, 'square', 0.1, 0.05), 100); setTimeout(() => playTone(1000, 'square', 0.2, 0.05), 200); break;
                case 'turn': playTone(600, 'sine', 0.3, 0.05); break;
                case 'win': for(let i=0; i<3; i++) setTimeout(() => { playTone(500, 'square', 0.1, 0.1); setTimeout(()=>playTone(800, 'square', 0.2, 0.1), 100); }, i*300); break;
            }
        };

        // --- ÂõæÊ†á ---
        const ICONS = {
            star: <svg viewBox="0 0 24 24" fill="currentColor" width="100%" height="100%"><path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"/></svg>,
            heart: <svg viewBox="0 0 24 24" fill="currentColor" width="100%" height="100%"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/></svg>,
            crown: <svg viewBox="0 0 24 24" fill="currentColor" width="100%" height="100%"><path d="M5 16L3 5l5.5 5L12 4l3.5 6L21 5l-2 11h-14zm14 3c0 .6-.4 1-1 1H6c-.6 0-1-.4-1-1v-1h14v1z"/></svg>,
            robot: <svg viewBox="0 0 24 24" fill="currentColor" width="100%" height="100%"><path d="M12 2a2 2 0 0 1 2 2c0 .74-.4 1.39-1 1.73V7h1a7 7 0 0 1 7 7h1a1 1 0 0 1 1 1v3a1 1 0 0 1-1 1h-1v1a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-1H2a1 1 0 0 1-1-1v-3a1 1 0 0 1 1-1h1a7 7 0 0 1 7-7h1V5.73c-.6-.34-1-.99-1-1.73a2 2 0 0 1 2-2M7.5 13A2.5 2.5 0 0 0 5 15.5A2.5 2.5 0 0 0 7.5 18a2.5 2.5 0 0 0 2.5-2.5A2.5 2.5 0 0 0 7.5 13m9 0a2.5 2.5 0 0 0-2.5 2.5a2.5 2.5 0 0 0 2.5 2.5a2.5 2.5 0 0 0 2.5-2.5a2.5 2.5 0 0 0-2.5-2.5z"/></svg>,
            car: <svg viewBox="0 0 24 24" fill="currentColor" width="100%" height="100%"><path d="M18.92 6.01C18.72 5.42 18.16 5 17.5 5h-11c-.66 0-1.21.42-1.42 1.01L3 12v8c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-1h12v1c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-8l-2.08-5.99zM6.5 16c-.83 0-1.5-.67-1.5-1.5S5.67 13 6.5 13s1.5.67 1.5 1.5S7.33 16 6.5 16zm11 0c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5zM5 11l1.5-4.5h11L19 11H5z"/></svg>,
            ship: <svg viewBox="0 0 24 24" fill="currentColor" width="100%" height="100%"><path d="M20 21c-1.39 0-2.78-.47-4-1.32-2.44 1.71-5.56 1.71-8 0C6.78 20.53 5.39 21 4 21H2v2h2c1.38 0 2.74-.35 4-.99 2.52 1.29 5.48 1.29 8 0 1.26.65 2.62.99 4 .99h2v-2h-2zM3.95 19H4c1.6 0 3.02-.88 4-2 .98 1.12 2.4 2 4 2s3.02-.88 4-2c.98 1.12 2.4 2 4 2h.05l1.89-6.68c.08-.26.06-.54-.06-.78s-.34-.42-.6-.5L20 10.62V6c0-1.1-.9-2-2-2h-3V1H9v3H6c-1.1 0-2 .9-2 2v4.62l-1.29.42c-.26.08-.48.26-.6.5s-.15.52-.06.78L3.95 19zM6 6h12v3.97L12 8 6 9.97V6z"/></svg>,
            smile: <svg viewBox="0 0 24 24" fill="currentColor" width="100%" height="100%"><path d="M11.99 2C6.47 2 2 6.48 2 12s4.47 10 9.99 10C17.52 22 22 17.52 22 12S17.52 2 11.99 2zM12 20c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8zm3.5-9c.83 0 1.5-.67 1.5-1.5S16.33 8 15.5 8 14 8.67 14 9.5s.67 1.5 1.5 1.5zm-7 0c.83 0 1.5-.67 1.5-1.5S9.33 8 8.5 8 7 8.67 7 9.5 7.67 11 8.5 11zm3.5 6.5c2.33 0 4.31-1.46 5.11-3.5H6.89c.8 2.04 2.78 3.5 5.11 3.5z"/></svg>,
            paw: <svg viewBox="0 0 24 24" fill="currentColor" width="100%" height="100%"><path d="M14 11.5a2.5 2.5 0 0 1-5 0 2.5 2.5 0 0 1 5 0zm3.5-3a2.5 2.5 0 0 1-5 0 2.5 2.5 0 0 1 5 0zm-11 0a2.5 2.5 0 0 1-5 0 2.5 2.5 0 0 1 5 0zm7 7.5a6 6 0 0 1-6-6 6 6 0 0 1 12 0 6 6 0 0 1-6 6z"/></svg>,
        };

        const CHARACTER_ROSTER = [
            { id: 'huang', name: "ÈªÑÂ∞èË∂ä", color: "#eab308", bgLight: "#fef9c3", icon: ICONS.star, desc: "ÁªèËøáËµ∑ÁÇπÂ∑•ËµÑ+$2", ability: "start_bonus" },
            { id: 'pinky', name: "Á≤âÁ∫¢Ë±π", color: "#ec4899", bgLight: "#fce7f3", icon: ICONS.heart, desc: "Êî∂ÁßüÊó∂Â§öÊî∂$1", ability: "rent_bonus" },
            { id: 'tech', name: "ÁßëÊäÄ‰æ†", color: "#3b82f6", bgLight: "#dbeafe", icon: ICONS.robot, desc: "ÂçáÁ∫ßÊàøÂ≠êÂ∞ëËä±$2", ability: "upgrade_discount" },
            { id: 'king', name: "Â§öÈáëÁéã", color: "#f59e0b", bgLight: "#fef3c7", icon: ICONS.crown, desc: "ÂàùÂßãËµÑÈáë+$5", ability: "start_rich" },
            { id: 'racer', name: "ÊûÅÈÄüÂÆ¢", color: "#ef4444", bgLight: "#fee2e2", icon: ICONS.car, desc: "Êé∑1ÁÇπÂèØÈáçÊé∑", ability: "reroll_1" },
            { id: 'sailor', name: "Ëà™Êµ∑ÂÆ∂", color: "#06b6d4", bgLight: "#cffafe", icon: ICONS.ship, desc: "Êú∫‰ºöÊÄªÊòØÂ•ΩËøê", ability: "lucky_chance" },
            { id: 'smile', name: "‰πêÂ§©Ê¥æ", color: "#8b5cf6", bgLight: "#ede9fe", icon: ICONS.smile, desc: "‰ªòÊàøÁßüÂ∞ë‰ªò$1", ability: "pay_less" },
            { id: 'cat', name: "ÂñµÊòü‰∫∫", color: "#f97316", bgLight: "#ffedd5", icon: ICONS.paw, desc: "30%Âá†ÁéáÂÖçÁßü", ability: "dodge_rent" },
        ];

        const BUSINESS_DATA = [
            {n:"Á≥ñÊûúÂ∫ó",i:"üç¨"}, {n:"Áé©ÂÖ∑Â∫ó",i:"üß∏"}, {n:"Ê±âÂ†°Â∫ó",i:"üçî"}, {n:"ÊñáÂÖ∑Â∫ó",i:"‚úèÔ∏è"}, {n:"Ê∞¥ÊûúÊëä",i:"üçé"}, 
            {n:"Ê∏∏‰πêÂú∫",i:"üé°"}, {n:"ÂÜ∞Ê∑áÊ∑ã",i:"üç¶"}, {n:"‰π¶Â∫ó",i:"üìö"}, {n:"ÁîµÂΩ±Èô¢",i:"üé¨"}, {n:"ÁßëÊäÄÈ¶Ü",i:"üöÄ"},
            {n:"ËõãÁ≥ïÊàø",i:"üç∞"}, {n:"Âä®Áâ©Âõ≠",i:"ü¶Å"}, {n:"Ê∞¥ÊóèÈ¶Ü",i:"üê¨"}, {n:"Êä´Ëê®Â∫ó",i:"üçï"}, {n:"‰πêÈ´òÂ∫ó",i:"üß±"}
        ];

        function App() {
            const [stage, setStage] = useState('menu');
            const [settings, setSettings] = useState({ playerCount: 2, mapSize: 'normal', sound: true });
            const [selectedChars, setSelectedChars] = useState({0: 'huang'}); 
            
            const [tiles, setTiles] = useState([]);
            const [gridConfig, setGridConfig] = useState({ cols: 6, rows: 7 });
            
            const [players, setPlayers] = useState([]);
            const [turn, setTurn] = useState(0);
            const [dice, setDice] = useState(1);
            const [isRolling, setIsRolling] = useState(false);
            const [movingPlayerId, setMovingPlayerId] = useState(null);
            const [modal, setModal] = useState(null);
            const [logs, setLogs] = useState(["ÂºÄÂßãÊåëÊàòÂêßÔºÅ"]);
            const [floatTexts, setFloatTexts] = useState([]);
            const [assetTab, setAssetTab] = useState('stats');
            const [mapCoins, setMapCoins] = useState([]);

            const play = (eff) => playSound(eff, settings.sound);

            const handleCharSelect = (idx, charId) => {
                if (Object.values(selectedChars).includes(charId) && selectedChars[idx] !== charId) return;
                setSelectedChars(prev => ({...prev, [idx]: charId}));
            };

            const confirmSelection = () => {
                if (Object.keys(selectedChars).length < settings.playerCount) { alert("ËØ∑‰∏∫ÊâÄÊúâÁé©ÂÆ∂ÈÄâÊã©ËßíËâ≤ÔºÅ"); return; }
                startGame();
            };

            const startGame = () => {
                if (audioCtx.state === 'suspended') audioCtx.resume();
                const cols = 6;
                let rows = 7; 
                if(settings.mapSize === 'large') rows = 9;
                if(settings.mapSize === 'epic') rows = 12;

                const total = cols * rows;
                const newTiles = createSnakeMap(total);
                
                setGridConfig({ cols, rows });
                setTiles(newTiles);
                
                // ÈöèÊú∫ÊííÈáëÂ∏Å (ÊØè8Ê†º‰∏Ä‰∏™)
                const coins = [];
                for(let i=3; i<total; i+=8) {
                    if (Math.random() > 0.3) coins.push({ id: i, val: 2 });
                }
                setMapCoins(coins);
                
                const initP = Array.from({ length: settings.playerCount }, (_, i) => {
                    const charData = CHARACTER_ROSTER.find(c => c.id === (selectedChars[i] || CHARACTER_ROSTER[i].id));
                    let startMoney = 50;
                    if (charData.ability === 'start_rich') startMoney += 5; // Â§öÈáëÁéãËÉΩÂäõ

                    return {
                        id: i, name: charData.name, color: charData.color, bgLight: charData.bgLight, icon: charData.icon,
                        money: startMoney, 
                        pos: 0, inJail: false, isBankrupt: false,
                        ability: charData.ability,
                        stats: { income: { rent: 0, salary: 0, other: 0 }, expense: { buy: 0, rent: 0, tax: 0 } }
                    };
                });
                setPlayers(initP);
                setTurn(0);
                setLogs([`ÊØè‰∫∫$50ÔºåË∞ÅÂÖàËµöÂà∞$100Ëé∑ËÉúÔºÅ`]);
                setStage('playing');
                play('turn');
            };

            const createSnakeMap = (total) => {
                const arr = [];
                const colors = ['orange', 'yellow', 'green', 'cyan', 'blue', 'purple', 'pink', 'rose', 'red', 'teal'];
                let colorIdx = 0;
                for (let i = 0; i < total; i++) {
                    if (i === 0) { arr.push({ id: i, type: 'start', name: 'Ëµ∑ÁÇπ', icon: 'üèÅ', color: 'slate' }); continue; }
                    const rand = Math.random();
                    
                    // Êï∞Â≠¶‰ºòÂåñÁâàÔºöÂú∞‰ª∑10-20
                    let tilePrice = 10 + Math.floor((i / total) * 10);
                    if (tilePrice % 2 !== 0) tilePrice += 1;
                    
                    let rentPrice = Math.max(2, Math.floor(tilePrice * 0.2)); 
                    if (rentPrice % 2 !== 0) rentPrice += 1;

                    if (i % 6 === 0) {
                        if (rand > 0.7) arr.push({ id: i, type: 'chance', name: 'Êú∫‰ºö', icon: '‚ùì', color: 'amber' });
                        else if (rand > 0.4) arr.push({ id: i, type: 'tax', name: 'Á®éÂ±Ä', icon: 'üí∏', color: 'stone', amount: 5 });
                        else arr.push({ id: i, type: 'hospital', name: 'ÂåªÈô¢', icon: 'üè•', color: 'red', amount: 5 });
                        continue;
                    }
                    if (i === Math.floor(total * 0.25)) { arr.push({ id: i, type: 'jail', name: 'Êé¢Áõë', icon: '‚õìÔ∏è', color: 'slate' }); continue; }
                    if (i === Math.floor(total * 0.5)) { arr.push({ id: i, type: 'parking', name: '‰ºëÊÅØ', icon: 'üí§', color: 'slate' }); continue; }
                    if (i === Math.floor(total * 0.75)) { arr.push({ id: i, type: 'casino', name: 'ËµåÂú∫', icon: 'üé∞', color: 'violet' }); continue; }
                    if (i === total - 3) { arr.push({ id: i, type: 'gotojail', name: 'Ë¢´Êçï', icon: 'üëÆ', color: 'slate' }); continue; }
                    
                    const biz = BUSINESS_DATA[i % BUSINESS_DATA.length];
                    if (i > 0 && i % 4 === 0) colorIdx = (colorIdx + 1) % colors.length;
                    arr.push({ id: i, type: 'prop', name: biz.n, icon: biz.i, color: colors[colorIdx % colors.length], price: tilePrice, rent: rentPrice, level: 0, owner: null });
                }
                return arr;
            };

            const rollDice = async () => {
                if (isRolling || movingPlayerId !== null || modal) return;
                if (audioCtx.state === 'suspended') await audioCtx.resume();
                
                setIsRolling(true); play('dice');
                for(let i=0; i<8; i++) { await new Promise(r => setTimeout(r, 60)); setDice(Math.floor(Math.random()*6)+1); }
                
                let val = Math.floor(Math.random()*6)+1;
                // ÊûÅÈÄüÂÆ¢ËÉΩÂäõ
                if (players[turn].ability === 'reroll_1' && val === 1) {
                    setLogs(p=>["ÊûÅÈÄüÂÆ¢Ëß¶ÂèëÔºöÈáçÊé∑ÔºÅ", ...p]);
                    val = Math.floor(Math.random()*6)+1;
                }

                setDice(val); setIsRolling(false);
                handleMove(turn, val);
            };

            const handleMove = async (pId, steps) => {
                setMovingPlayerId(pId);
                const player = players[pId];
                if (player.inJail) {
                    if (steps >= 4) { setLogs(p=>["Ë∂äÁã±ÊàêÂäüÔºÅ", ...p]); updatePlayer(pId, { inJail: false }); play('coin'); } 
                    else { setLogs(p=>["Ë∂äÁã±Â§±Ë¥•...", ...p]); play('pay'); setTimeout(() => { setMovingPlayerId(null); nextTurn(); }, 1000); return; }
                }
                let curPos = player.pos;
                for (let i = 0; i < steps; i++) {
                    curPos = (curPos + 1) % tiles.length;
                    updatePlayer(pId, { pos: curPos });
                    play('step');
                    
                    // Êç°ÈáëÂ∏Å
                    const coinIdx = mapCoins.findIndex(c => c.id === curPos);
                    if (coinIdx > -1) {
                        transfer(null, pId, mapCoins[coinIdx].val, 'other');
                        setMapCoins(prev => prev.filter((_, idx) => idx !== coinIdx));
                        setLogs(p=>["Êç°Âà∞ÈáëÂ∏Å +$2", ...p]);
                    }

                    await new Promise(r => setTimeout(r, 200));
                }
                if (player.pos + steps >= tiles.length && !player.inJail) {
                    let salary = 10;
                    if (player.ability === 'start_bonus') salary += 2; // ÈªÑÂ∞èË∂äËÉΩÂäõ
                    setLogs(p=>[`ÁªèËøáËµ∑ÁÇπ +$${salary}`, ...p]); transfer(null, pId, salary, 'salary');
                }
                setMovingPlayerId(null);
                setTimeout(() => resolveTile(curPos, pId), 300);
            };

            const resolveTile = (pos, pId) => {
                const tile = tiles[pos];
                const player = players[pId];
                if (tile.type === 'prop') {
                    if (tile.owner === null) {
                        if (player.money >= tile.price) { setModal({ type: 'buy', tile }); play('turn'); }
                        else { setLogs(p=>["Èí±‰∏çÂ§ü‰π∞", ...p]); nextTurn(); }
                    } else if (tile.owner === pId) {
                        let cost = Math.ceil(tile.price/2);
                        if (player.ability === 'upgrade_discount') cost = Math.max(1, cost - 2); // ÁßëÊäÄ‰æ†ËÉΩÂäõ
                        if (tile.level < 2) { setModal({ type: 'upgrade', tile, cost }); play('turn'); }
                        else { setLogs(p=>["Â∑≤Êª°Á∫ß", ...p]); nextTurn(); }
                    } else {
                        const owner = players[tile.owner];
                        if (!owner.isBankrupt) {
                            const multiplier = tile.level === 0 ? 1 : (tile.level === 1 ? 2 : 3);
                            let rent = tile.rent * multiplier;
                            
                            // ÊäÄËÉΩÁªìÁÆó
                            if (owner.ability === 'rent_bonus') rent += 1; // Á≤âÁ∫¢Ë±πÂä†Áßü
                            if (player.ability === 'pay_less') rent = Math.max(0, rent - 1); // ‰πêÂ§©Ê¥æÂáèÁßü
                            if (player.ability === 'dodge_rent' && Math.random() < 0.3) {
                                setLogs(p=>["ËêåÊ∑∑ËøáÂÖ≥ÔºåÂÖçÁßüÈáëÔºÅ", ...p]); rent = 0; // ÂñµÊòü‰∫∫
                            }

                            if (rent > 0) {
                                setModal({ type: 'rent', tile, owner, amount: rent });
                                play('pay');
                            } else {
                                nextTurn();
                            }
                        } else { setLogs(p=>["ÂÖçÁßüÈáë", ...p]); nextTurn(); }
                    }
                }
                else if (tile.type === 'chance') { 
                    const isLucky = player.ability === 'lucky_chance' || Math.random() > 0.5;
                    setModal({ type: 'event', ...(isLucky ? {t:"Êç°Âà∞Èí± +$5",v:5,g:true} : {t:"‰∏¢‰∫ÜÈí± -$5",v:-5,g:false}) }); 
                }
                else if (tile.type === 'casino') setModal({ type: 'casino' });
                else if (tile.type === 'hospital') { setLogs(p=>["ÁúãÂåªÁîü -$5", ...p]); transfer(pId, null, 5, 'tax'); setTimeout(nextTurn, 800); }
                else if (tile.type === 'tax') { setLogs(p=>[`‰∫§Á®é $${tile.amount}`, ...p]); transfer(pId, null, tile.amount, 'tax'); setTimeout(nextTurn, 800); }
                else if (tile.type === 'gotojail') { setLogs(p=>["ÊöÇÂÅú‰∏ÄÂõûÂêàÔºÅ", ...p]); updatePlayer(pId, { pos: tiles.findIndex(t => t.type === 'jail') || 0, inJail: true }); play('pay'); setTimeout(nextTurn, 1000); }
                else nextTurn();
            };

            const updatePlayer = (id, data) => setPlayers(prev => prev.map(p => p.id === id ? {...p, ...data} : p));
            const updateTile = (id, data) => setTiles(prev => prev.map(t => t.id === id ? {...t, ...data} : t));
            
            const showFloatText = (playerId, text, color) => {
                const id = Date.now() + Math.random();
                const pos = players[playerId].pos;
                setFloatTexts(prev => [...prev, { id, text, color, pos }]);
                setTimeout(() => setFloatTexts(prev => prev.filter(ft => ft.id !== id)), 1500);
            };

            const transfer = (from, to, val, reason) => {
                if (from !== null) { showFloatText(from, `-${val}`, 'text-red-500'); play('pay'); }
                if (to !== null) { showFloatText(to, `+${val}`, 'text-green-500'); play('coin'); }
                
                setPlayers(prev => prev.map(p => {
                    let newP = { ...p };
                    if (from !== null && p.id === from) {
                        if (newP.money < val) {
                            const myAssets = tiles.filter(t => t.owner === p.id).sort((a,b) => a.price - b.price);
                            let recovered = 0, sold = [];
                            for (let asset of myAssets) {
                                if (newP.money + recovered >= val) break;
                                const sell = Math.floor(asset.price / 2);
                                recovered += sell; sold.push(asset.id);
                                setLogs(prev => [`üí∏ ÂçñÊéâ${asset.name} (+$${sell})`, ...prev]);
                            }
                            if (sold.length > 0) { setTiles(ts => ts.map(t => sold.includes(t.id) ? { ...t, owner: null, level: 0 } : t)); newP.money += recovered; }
                        }
                        newP.money -= val;
                        if (reason === 'buy') newP.stats.expense.buy += val;
                        if (reason === 'rent') newP.stats.expense.rent += val;
                        if (reason === 'tax') newP.stats.expense.tax += val;
                    }
                    if (to !== null && p.id === to) {
                        newP.money += val;
                        if (reason === 'rent') newP.stats.income.rent += val;
                        if (reason === 'salary') newP.stats.income.salary += val;
                        if (reason === 'other') newP.stats.income.other += val;
                    }
                    return newP;
                }));
            };

            const checkWin = (currentPlayers) => {
                // ËÉúÂà©Êù°‰ª∂ÔºöËµÑ‰∫ß > 100
                const winner = currentPlayers.find(p => {
                    const assets = p.money + tiles.filter(t=>t.owner===p.id).reduce((a,b)=>a+b.price, 0);
                    return assets >= 100;
                });
                if (winner) {
                    setStage('gameover');
                    return true;
                }
                return false;
            };

            const nextTurn = () => {
                setPlayers(curr => {
                    const nextP = curr.map(p => {
                        if (p.money < 0 && !p.isBankrupt) {
                            setTiles(ts => ts.map(t => t.owner === p.id ? { ...t, owner: null, level: 0 } : t));
                            setLogs(prev => [`üíî ${p.name} Á†¥‰∫ß‰∫ÜÔºÅ`, ...prev]);
                            return { ...p, isBankrupt: true, money: 0 };
                        }
                        return p;
                    });
                    
                    if (checkWin(nextP)) return nextP;

                    const alive = nextP.filter(p => !p.isBankrupt);
                    if (alive.length === 1) { setStage('gameover'); return nextP; }
                    
                    let next = (turn + 1) % nextP.length;
                    while (nextP[next].isBankrupt) next = (next + 1) % nextP.length;
                    setTurn(next);
                    play('turn');
                    return nextP;
                });
            };

            const actions = {
                buy: () => { transfer(turn, null, modal.tile.price, 'buy'); updateTile(modal.tile.id, { owner: turn, level: 0 }); setLogs(p=>[`‰π∞‰∏ã ${modal.tile.name}`, ...p]); setModal(null); play('upgrade'); nextTurn(); },
                upgrade: () => { transfer(turn, null, modal.cost, 'buy'); updateTile(modal.tile.id, { level: modal.tile.level + 1 }); setLogs(p=>[`ÂçáÁ∫ß ${modal.tile.name}`, ...p]); setModal(null); play('upgrade'); nextTurn(); },
                rent: () => { transfer(turn, modal.owner.id, modal.amount, 'rent'); setLogs(p=>[`‰ªòÁßüÈáë $${modal.amount}`, ...p]); setModal(null); nextTurn(); },
                event: () => { if (modal.v > 0) transfer(null, turn, modal.v, 'other'); else transfer(turn, null, Math.abs(modal.v), 'tax'); setModal(null); nextTurn(); },
                casino: () => { setModal(null); setTimeout(() => { const win = Math.random() > 0.5; const amount = 5; if (win) { transfer(null, turn, amount, 'other'); setModal({ type: 'alert', title: "üé∞ Ëµ¢‰∫ÜÔºÅ", msg: `Ëé∑Âæó $${amount}`, color: 'text-green-500' }); } else { transfer(turn, null, amount, 'tax'); setModal({ type: 'alert', title: "üé∞ Ëæì‰∫Ü...", msg: `Â§±Âéª $${amount}`, color: 'text-red-500' }); } }, 500); },
                closeAlert: () => { setModal(null); nextTurn(); }
            };

            const getSnakePos = (idx) => {
                const { cols } = gridConfig;
                const row = Math.floor(idx / cols);
                let col = idx % cols;
                if (row % 2 !== 0) col = cols - 1 - col;
                return { col: col + 1, row: row + 1 };
            };

            const getArrowDir = (idx) => {
                if (idx === tiles.length - 1) return null;
                const curr = getSnakePos(idx);
                const next = getSnakePos(idx + 1);
                if (next.col > curr.col) return 'right';
                if (next.col < curr.col) return 'left';
                if (next.row > curr.row) return 'down';
                return null;
            };

            // --- UI ---
            const Controls = () => (
                <>
                    <div className="bg-slate-800/50 rounded-xl p-4 flex-1 overflow-hidden flex flex-col border border-slate-700">
                        <h3 className="text-xs font-bold text-slate-400 mb-2 uppercase tracking-wider flex justify-between">
                            <span>Ê∂àÊÅØ</span>
                            <span className="cursor-pointer hover:text-white" onClick={()=>setSettings(s=>({...s, sound: !s.sound}))}>{settings.sound ? 'üîä' : 'üîá'}</span>
                        </h3>
                        <div className="flex-1 overflow-y-auto no-scrollbar flex flex-col gap-2">
                            {logs.map((l, i) => <div key={i} className={`text-xs ${i===0?'text-white font-bold':'text-slate-400'}`}>{l}</div>)}
                        </div>
                    </div>
                    {/* ÊèêÁ§∫Ê†è */}
                    <div className="text-center bg-slate-800/80 p-2 rounded-lg border border-slate-600 animate-pulse">
                        <div className="text-xs text-slate-400 mb-1">Áé∞Âú®ËΩÆÂà∞</div>
                        <div className="flex items-center justify-center gap-2 font-bold text-lg" style={{color: currentPlayer.color}}>
                            {currentPlayer.name} <span className="text-2xl">üé≤</span> ËØ∑ÊäïÈ™∞Â≠ê
                        </div>
                    </div>
                    <div className="flex items-center justify-center gap-4 pb-4">
                        <button onClick={rollDice} disabled={isRolling || modal} className={`dice-btn w-24 h-24 text-4xl shadow-xl ${isRolling ? 'dice-rolling' : ''}`}>{dice}</button>
                    </div>
                    <div className="grid grid-cols-2 md:grid-cols-1 gap-3">
                        {players.map(p => {
                            const assets = p.money + (tiles.length ? tiles.filter(t=>t.owner===p.id).reduce((a,b)=>a+b.price,0) : 0);
                            const progress = Math.min(100, (assets/100)*100);
                            return (
                                <div key={p.id} onClick={() => {setModal({ type: 'asset', p }); setAssetTab('stats');}} className={`player-card ${turn === p.id ? 'active' : ''} ${p.isBankrupt ? 'bankrupt' : ''}`}>
                                    <div className="skill-badge">{CHARACTER_ROSTER.find(c=>c.name===p.name)?.desc}</div>
                                    <div className="w-10 h-10 rounded-full flex items-center justify-center text-white" style={{backgroundColor: p.color}}><div style={{width:'20px', height:'20px'}}>{p.icon}</div></div>
                                    <div className="flex-1 min-w-0">
                                        <div className="text-xs font-bold text-slate-300 flex justify-between"><span>{p.name}</span>{p.inJail && <span className="text-red-500">Áã±</span>}</div>
                                        <div className="text-sm font-mono font-bold text-green-400">${p.money} <span className="text-[10px] text-slate-500">/ ÊÄª${assets}</span></div>
                                        {/* ËøõÂ∫¶Êù° */}
                                        <div className="w-full h-1 bg-slate-700 rounded-full mt-1 overflow-hidden"><div className="h-full transition-all duration-500" style={{width: `${progress}%`, backgroundColor: p.color}}></div></div>
                                    </div>
                                </div>
                            );
                        })}
                    </div>
                </>
            );

            if (stage === 'menu') return (
                <div className="flex h-full items-center justify-center bg-slate-900 p-6 relative overflow-hidden">
                    <div className="absolute inset-0 opacity-10 bg-[url('https://www.transparenttextures.com/patterns/cubes.png')]"></div>
                    <div className="w-full max-w-sm bg-slate-800/90 backdrop-blur p-8 rounded-3xl border border-slate-700 shadow-2xl text-center relative z-10">
                        <h1 className="text-4xl font-black text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-purple-500 mb-2">„ÄêÂ§ßÂØåÁøÅ-100‰ª•ÂÜÖÂä†ÂáèÁâà„Äë</h1>
                        <p className="text-slate-400 text-sm mb-8 font-bold tracking-widest">‰∏ì‰∏∫ÈªÑÂ∞èË∂äÂÆöÂà∂</p>
                        <div className="space-y-6">
                            <div className="text-left"><label className="text-xs text-slate-500 font-bold mb-2 block">Âá†‰∏™Â∞èÊúãÂèãÁé©Ôºü</label><div className="flex gap-2">{[2,3,4].map(n => <button key={n} onClick={()=>setSettings({...settings, playerCount:n})} className={`flex-1 py-3 rounded-xl font-bold transition-all ${settings.playerCount===n?'bg-blue-600 text-white shadow-lg':'bg-slate-700 text-slate-400'}`}>{n}‰∫∫</button>)}</div></div>
                            <div className="text-left"><label className="text-xs text-slate-500 font-bold mb-2 block">Âú∞ÂõæÂ§ßÂ∞è</label><div className="grid grid-cols-1 gap-2"><button onClick={()=>setSettings({...settings, mapSize:'normal'})} className={`p-3 rounded-xl border text-left transition-all ${settings.mapSize==='normal'?'border-blue-500 bg-blue-500/10':'border-slate-600 bg-slate-700'}`}><div className="font-bold text-white text-sm">Ê†áÂáÜ (42Ê†º)</div></button><button onClick={()=>setSettings({...settings, mapSize:'large'})} className={`p-3 rounded-xl border text-left transition-all ${settings.mapSize==='large'?'border-purple-500 bg-purple-500/10':'border-slate-600 bg-slate-700'}`}><div className="font-bold text-white text-sm">Âä†Èïø (54Ê†º)</div></button></div></div>
                        </div>
                        <button onClick={()=>setStage('char_select')} className="w-full mt-8 py-4 bg-gradient-to-r from-blue-600 to-indigo-600 rounded-xl font-bold text-white shadow-xl hover:scale-105 transition-transform">‰∏ã‰∏ÄÊ≠•</button>
                    </div>
                </div>
            );

            if (stage === 'char_select') return (
                <div className="flex h-full flex-col bg-slate-900 p-6 overflow-hidden">
                    <h2 className="text-2xl font-bold text-white mb-6 text-center">ÈÄâÊã©ËßíËâ≤</h2>
                    <div className="flex-1 overflow-y-auto no-scrollbar">
                        <div className="grid grid-cols-2 gap-4">
                            {Array.from({length: settings.playerCount}).map((_, idx) => (
                                <div key={idx} className="bg-slate-800 rounded-xl p-4 border border-slate-700">
                                    <div className="text-sm text-slate-400 mb-2 font-bold">Áé©ÂÆ∂ {idx + 1}</div>
                                    <div className="grid grid-cols-4 gap-2">
                                        {CHARACTER_ROSTER.map(char => {
                                            const isSelected = selectedChars[idx] === char.id;
                                            const isTaken = Object.values(selectedChars).includes(char.id) && !isSelected;
                                            return <button key={char.id} onClick={() => handleCharSelect(idx, char.id)} disabled={isTaken} className={`aspect-square rounded-lg flex items-center justify-center transition-all ${isSelected ? 'ring-2 ring-white scale-110 z-10' : ''} ${isTaken ? 'opacity-20 grayscale' : 'hover:bg-slate-700'}`} style={{backgroundColor: isTaken ? 'transparent' : char.color}}><div style={{width:'20px', height:'20px', color:'white'}}>{char.icon}</div></button>;
                                        })}
                                    </div>
                                    <div className="mt-3 text-center h-5 text-sm font-bold text-white">{selectedChars[idx] ? CHARACTER_ROSTER.find(c=>c.id===selectedChars[idx]).name : <span className="text-slate-500">?</span>}</div>
                                    <div className="text-xs text-center text-slate-400 mt-1">{selectedChars[idx] ? CHARACTER_ROSTER.find(c=>c.id===selectedChars[idx]).desc : ""}</div>
                                </div>
                            ))}
                        </div>
                    </div>
                    <button onClick={confirmSelection} className="w-full mt-4 py-4 bg-green-600 rounded-xl font-bold text-white shadow-xl">ÂºÄÂßãÊ∏∏Êàè</button>
                </div>
            );

            if (stage === 'gameover') {
                const winner = players.find(p => {
                    const assets = p.money + tiles.filter(t=>t.owner===p.id).reduce((a,b)=>a+b.price, 0);
                    return assets >= 100;
                }) || players.find(p=>!p.isBankrupt);
                
                return (<div className="flex h-full items-center justify-center bg-slate-900 text-white relative"><div className="text-center z-10"><div className="text-8xl mb-4 animate-bounce">üèÜ</div><h2 className="text-2xl font-bold mb-2 text-slate-400">ËµÑ‰∫ßËææÂà∞$100ÔºÅ</h2><div className="text-6xl font-black mb-12" style={{color: winner.color}}>{winner.name}</div><button onClick={()=>window.location.reload()} className="px-10 py-4 bg-slate-800 border border-slate-600 rounded-full font-bold hover:bg-slate-700 transition-colors">ÂÜçÁé©‰∏ÄÊ¨°</button></div></div>);
            }

            const currentPlayer = players[turn];

            return (
                <div className="app-container">
                    <div className="board-section">
                        <div className="board-grid" style={{ gridTemplateColumns: `repeat(${gridConfig.cols}, 1fr)` }}>
                            {tiles.map((t, i) => {
                                const pos = getSnakePos(i);
                                const owner = t.owner !== null ? players[t.owner] : null;
                                const dir = getArrowDir(i);
                                const coin = mapCoins.find(c => c.id === i);
                                return (
                                    <div key={i} className={`tile ${owner ? 'owned' : ''}`} style={{ gridColumn: pos.col, gridRow: pos.row, backgroundColor: owner ? owner.bgLight : (t.type !== 'prop' ? '#f1f5f9' : '#ffffff'), borderColor: owner ? owner.color : 'transparent', borderWidth: owner ? '2px' : '0' }}>
                                        <div className={`street-bar ${t.color === 'slate' ? 'bg-slate-400' : `bg-${t.color}-400`}`} style={{backgroundColor: t.color === 'slate' ? null : null }}></div>
                                        <div className="tile-idx">{i}</div>
                                        {dir === 'right' && <div className="path-arrow arrow-right">‚ûú</div>}
                                        {dir === 'left' && <div className="path-arrow arrow-left">‚¨Ö</div>}
                                        {dir === 'down' && <div className="path-arrow arrow-down">‚¨á</div>}
                                        {i === tiles.length - 1 && <div className="return-start">‚Ü∫ ÂõûËµ∑ÁÇπ</div>}
                                        {t.level > 0 && <div className="level-stars">{[...Array(t.level)].map((_,k)=><span key={k}>{t.level===2?'üëë':'‚≠ê'}</span>)}</div>}
                                        {coin && <div className="map-coin">üí∞</div>}
                                        <div className="tile-content">
                                            <div className="tile-icon-div">{t.icon}</div>
                                            <div className="tile-name-div">{t.name}</div>
                                            {t.type==='prop' && !owner && <div className="tile-price-div">${t.price}</div>}
                                            {owner && <div className="tile-owner-div" style={{backgroundColor: owner.color}}>{owner.name}</div>}
                                        </div>
                                    </div>
                                );
                            })}
                            {players.map((p, idx) => {
                                if (p.isBankrupt) return null;
                                const pos = getSnakePos(p.pos);
                                const isMoving = movingPlayerId === idx;
                                const stackX = (idx % 2 === 0 ? -1 : 1) * 3;
                                const stackY = (idx < 2 ? -1 : 1) * 3;
                                return (
                                    <div key={idx} className="token" style={{ gridColumn: pos.col, gridRow: pos.row }}>
                                        <div style={{transform: `translate(${stackX}px, ${stackY}px)`}}>
                                            <div className={`token-body ${isMoving ? 'hopping' : ''}`} style={{backgroundColor: p.color}}><div style={{width:'12px', height:'12px'}}>{p.icon}</div></div>
                                        </div>
                                    </div>
                                );
                            })}
                            {floatTexts.map(ft => {
                                const pos = getSnakePos(ft.pos);
                                return <div key={ft.id} className="token" style={{ gridColumn: pos.col, gridRow: pos.row, zIndex: 100 }}><div className={`float-text ${ft.color}`}>{ft.text}</div></div>
                            })}
                        </div>
                    </div>

                    <div className="controls-section desktop-hud">
                        <div className="flex items-center gap-3 mb-4 border-b border-slate-700 pb-4"><div className="text-4xl">üé≤</div><div><h2 className="font-bold text-xl">ÊéßÂà∂Âè∞</h2><div className="text-xs text-slate-400">ÂõûÂêà: {currentPlayer.name}</div></div></div>
                        <Controls />
                    </div>

                    <div className="mobile-hud md:hidden">
                        {/* ÁßªÂä®Á´ØÊèêÁ§∫ */}
                        <div className="text-center bg-slate-800/80 p-2 rounded-lg border border-slate-600 mb-2">
                            <div className="flex items-center justify-center gap-2 font-bold text-lg" style={{color: currentPlayer.color}}>
                                {currentPlayer.name} <span className="text-2xl animate-bounce">üé≤</span> ËØ∑ÊäïÈ™∞Â≠ê
                            </div>
                        </div>
                        
                        <div className="flex justify-between items-end">
                            <div className="flex-1 mr-4 overflow-hidden" onClick={()=>setSettings(s=>({...s, sound: !s.sound}))}><div className="text-xs text-slate-400 mb-1">Ê∂àÊÅØ {settings.sound?'üîä':'üîá'}</div><div className="text-sm text-yellow-400 font-bold truncate">{logs[0]}</div></div>
                            <button onClick={rollDice} disabled={isRolling || modal} className={`dice-btn w-16 h-16 shrink-0 ${isRolling ? 'dice-rolling' : ''}`}>{dice}</button>
                        </div>
                        <div className="flex gap-2 overflow-x-auto no-scrollbar pt-2 border-t border-slate-700">
                            {players.map(p => {
                                const assets = p.money + (tiles.length ? tiles.filter(t=>t.owner===p.id).reduce((a,b)=>a+b.price,0) : 0);
                                const progress = Math.min(100, (assets/100)*100);
                                return (
                                    <div key={p.id} onClick={() => {setModal({ type: 'asset', p }); setAssetTab('stats');}} className={`shrink-0 w-24 bg-slate-800 rounded p-2 border border-slate-700 flex flex-col items-center gap-1 relative ${p.isBankrupt?'opacity-30':''} ${turn===p.id ? 'ring-2 ring-yellow-400' : ''}`}>
                                        <div className="w-6 h-6 rounded-full flex items-center justify-center text-white text-xs" style={{backgroundColor: p.color}}><div style={{width:'12px', height:'12px'}}>{p.icon}</div></div>
                                        <div className="text-xs font-mono text-green-400 font-bold">${p.money}</div>
                                        <div className="w-full h-1 bg-slate-600 rounded-full mt-1"><div className="h-full" style={{width: `${progress}%`, backgroundColor: p.color}}></div></div>
                                    </div>
                                );
                            })}
                        </div>
                    </div>

                    {modal && (
                        <div className="fixed inset-0 z-[100] flex items-center justify-center modal-bg p-4 modal-content">
                            {modal.type !== 'asset' && (
                                <div className="bg-white w-full max-w-sm rounded-2xl p-6 text-center text-slate-900 shadow-2xl relative overflow-hidden">
                                    <div className="absolute top-0 left-0 right-0 h-2 bg-gradient-to-r from-blue-500 to-purple-600"></div>
                                    {modal.type === 'buy' && (
                                        <>
                                            <div className="text-5xl mb-3">{modal.tile.icon}</div>
                                            <h3 className="text-2xl font-black mb-1">{modal.tile.name}</h3>
                                            <p className="text-slate-500 mb-6 font-mono text-lg font-bold">‰ª∑Ê†º ${modal.tile.price}</p>
                                            <div className="flex gap-3">
                                                <button onClick={()=>{setModal(null);nextTurn()}} className="flex-1 py-3 bg-slate-100 rounded-xl font-bold text-slate-600">‰∏ç‰π∞</button>
                                                <button onClick={actions.buy} className="flex-1 py-3 bg-blue-600 text-white rounded-xl font-bold shadow-lg shadow-blue-200">‰π∞‰∏ãÊù•</button>
                                            </div>
                                        </>
                                    )}
                                    {modal.type === 'rent' && (
                                        <>
                                            <div className="text-5xl mb-2">üí∏</div>
                                            <h3 className="text-xl font-bold mb-1">‰ªòÊàøÁßü</h3>
                                            <p className="text-slate-500 mb-6">ËøôÊòØ <span className="font-bold" style={{color:modal.owner.color}}>{modal.owner.name}</span> ÁöÑÂú∞Áõò</p>
                                            <div className="text-4xl font-black text-red-500 mb-8">-${modal.amount}</div>
                                            <button onClick={actions.rent} className="w-full py-3 bg-slate-800 text-white rounded-xl font-bold">ÊîØ‰ªò</button>
                                        </>
                                    )}
                                    {modal.type === 'event' && (
                                        <>
                                            <div className="text-5xl mb-4">{modal.good?'üéÅ':'‚ö°'}</div>
                                            <h3 className="text-xl font-bold mb-4">{modal.t}</h3>
                                            <button onClick={actions.event} className="w-full py-3 bg-slate-800 text-white rounded-xl font-bold">Á°ÆÂÆö</button>
                                        </>
                                    )}
                                    {modal.type === 'upgrade' && (
                                        <>
                                            <div className="text-5xl mb-3">üèóÔ∏è</div>
                                            <h3 className="text-xl font-bold mb-2">ÂçáÁ∫ßÊàøÂ≠ê</h3>
                                            <p className="text-green-600 font-bold text-xl mb-6">Ëä±Ë¥π ${modal.cost}</p>
                                            <div className="flex gap-3">
                                                <button onClick={()=>{setModal(null);nextTurn()}} className="flex-1 py-3 bg-slate-100 rounded-xl font-bold text-slate-500">‰∏çÂçá</button>
                                                <button onClick={actions.upgrade} className="flex-1 py-3 bg-yellow-500 text-white rounded-xl font-bold shadow">ÂçáÁ∫ß</button>
                                            </div>
                                        </>
                                    )}
                                    {modal.type === 'casino' && (
                                        <>
                                            <div className="text-5xl mb-3">üé∞</div>
                                            <h3 className="text-2xl font-bold mb-2">ÁåúÂ§ßÂ∞è</h3>
                                            <p className="text-slate-500 mb-6">Âè™Ë¶Å $5ÔºåËµ¢‰∫ÜËµöÁøªÔºÅ</p>
                                            <div className="flex gap-3">
                                                <button onClick={()=>{setModal(null);nextTurn()}} className="flex-1 py-3 bg-slate-100 rounded-xl font-bold">‰∏çÁé©</button>
                                                <button onClick={actions.casino} className="flex-1 py-3 bg-purple-600 text-white rounded-xl font-bold shadow">Áé©‰∏ÄÊää</button>
                                            </div>
                                        </>
                                    )}
                                    {modal.type === 'alert' && (
                                        <>
                                            <h3 className="text-2xl font-black mb-2">{modal.title}</h3>
                                            <p className={`text-lg font-bold mb-6 ${modal.color}`}>{modal.msg}</p>
                                            <button onClick={actions.closeAlert} className="w-full py-3 bg-slate-800 text-white rounded-xl font-bold">ÁªßÁª≠</button>
                                        </>
                                    )}
                                </div>
                            )}
                            
                            {modal.type === 'asset' && (
                                <div className="bg-white w-full max-w-md rounded-2xl p-5 text-slate-900 shadow-2xl flex flex-col max-h-[80vh]">
                                    <div className="flex justify-between items-center mb-4 border-b pb-2">
                                        <div className="flex items-center gap-2">
                                            <div className="w-8 h-8 rounded-full flex items-center justify-center text-white" style={{backgroundColor: modal.p.color}}><div style={{width:'16px', height:'16px'}}>{modal.p.icon}</div></div>
                                            <div><h3 className="font-bold text-lg leading-none">{modal.p.name}</h3><span className="text-xs text-slate-400">ÊÄªËµÑ‰∫ß: ${modal.p.money + tiles.filter(t=>t.owner===modal.p.id).reduce((a,b)=>a+b.price,0)}</span></div>
                                        </div>
                                        <button onClick={()=>setModal(null)} className="w-8 h-8 flex items-center justify-center bg-slate-100 rounded-full font-bold">√ó</button>
                                    </div>
                                    <div className="flex bg-slate-100 rounded-xl p-1 mb-4 shrink-0">
                                        <button onClick={()=>setAssetTab('stats')} className={`flex-1 py-2 text-sm font-bold rounded-lg transition-all ${assetTab==='stats'?'bg-white shadow text-blue-600':'text-slate-400'}`}>Êî∂ÊîØË°®</button>
                                        <button onClick={()=>setAssetTab('props')} className={`flex-1 py-2 text-sm font-bold rounded-lg transition-all ${assetTab==='props'?'bg-white shadow text-blue-600':'text-slate-400'}`}>ÊàøÂ≠ê</button>
                                    </div>
                                    {assetTab === 'stats' && (
                                        <div className="flex-1 overflow-y-auto">
                                            <div className="grid grid-cols-2 gap-3 mb-4">
                                                <div className="bg-green-50 p-3 rounded-xl border border-green-100">
                                                    <div className="text-xs font-bold text-green-600 uppercase mb-2 opacity-70">Ëµö‰∫Ü</div>
                                                    <div className="text-xl font-black text-green-700">${modal.p.stats.income.rent + modal.p.stats.income.salary + modal.p.stats.income.other}</div>
                                                </div>
                                                <div className="bg-red-50 p-3 rounded-xl border border-red-100">
                                                    <div className="text-xs font-bold text-red-600 uppercase mb-2 opacity-70">Ëä±‰∫Ü</div>
                                                    <div className="text-xl font-black text-red-700">${modal.p.stats.expense.buy + modal.p.stats.expense.rent + modal.p.stats.expense.tax}</div>
                                                </div>
                                            </div>
                                            <div className="bg-slate-50 p-4 rounded-xl border border-slate-200 flex justify-between items-center"><span className="font-bold text-slate-600">Áé∞Âú®Êúâ</span><span className="text-2xl font-mono font-black text-slate-800">${modal.p.money}</span></div>
                                        </div>
                                    )}
                                    {assetTab === 'props' && (
                                        <div className="overflow-y-auto flex-1 space-y-2 custom-scroll">
                                            {tiles.filter(t=>t.owner===modal.p.id).length === 0 ? <div className="flex flex-col items-center justify-center h-40 text-slate-400"><div className="text-4xl mb-2">üè†</div><div>ËøòÊ≤°Êúâ‰π∞ÊàøÂ≠êÂì¶</div></div> :
                                                tiles.filter(t=>t.owner===modal.p.id).map(t=>(
                                                    <div key={t.id} className="flex justify-between items-center p-3 bg-white rounded-xl border border-slate-100 shadow-sm">
                                                        <div className="flex items-center gap-3">
                                                            <div className="w-2 h-8 rounded-full" style={{backgroundColor: `var(--color-${t.color}-500)`}}></div>
                                                            <div>
                                                                <div className="font-bold text-slate-800 flex items-center gap-1"><span className="text-lg">{t.icon}</span> {t.name} {t.level>0 && <span className="bg-yellow-100 text-yellow-600 text-[10px] px-1 rounded border border-yellow-200">{t.level===2?'üëë':'‚≠ê'}</span>}</div>
                                                            </div>
                                                        </div>
                                                        <div className="text-right"><div className="text-xs text-slate-400">ÊàøÁßü</div><div className="font-mono font-bold text-blue-600">${t.rent * (t.level==0?1:t.level==1?2:3)}</div></div>
                                                    </div>
                                                ))
                                            }
                                        </div>
                                    )}
                                </div>
                            )}
                        </div>
                    )}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
