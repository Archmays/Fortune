<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Â§ßÂØåÁøÅ</title>
    
    <!-- React & Tailwind -->
    <script crossorigin src="https://unpkg.com/react@18.2.0/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;700;900&display=swap');
        
        :root {
            --bg-dark: #0f172a;
            --panel-bg: #1e293b;
            --tile-bg: #ffffff;
            --accent: #3b82f6;
        }

        body {
            font-family: 'Noto Sans SC', sans-serif;
            background-color: var(--bg-dark);
            color: #e2e8f0;
            overscroll-behavior: none;
            touch-action: manipulation;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
            height: 100vh;
            width: 100vw;
            overflow: hidden;
            margin: 0;
        }

        /* --- Â∏ÉÂ±ÄÁ≥ªÁªü --- */
        .app-container { display: flex; flex-direction: column; height: 100%; width: 100%; }

        /* Ê°åÈù¢Á´Ø/Ê®™Â±è */
        @media (min-width: 1024px) {
            .app-container { flex-direction: row; padding: 20px; gap: 20px; }
            .board-section { flex: 2; height: 100%; border-radius: 16px; background: #111827; box-shadow: inset 0 0 20px rgba(0,0,0,0.5); }
            .controls-section { flex: 1; max-width: 400px; display: flex; flex-direction: column; gap: 15px; }
            .mobile-hud { display: none !important; }
            .desktop-hud { display: flex !important; }
        }

        /* ÁßªÂä®Á´Ø/Á´ñÂ±è */
        @media (max-width: 1023px) {
            .board-section { flex: 1; width: 100%; overflow: hidden; position: relative; display: flex; align-items: center; justify-content: center; padding-bottom: 120px; }
            .controls-section { display: none; }
            .mobile-hud { display: flex !important; }
            .desktop-hud { display: none !important; }
        }

        /* --- Ê£ãÁõò --- */
        .board-grid {
            display: grid;
            gap: 3px; 
            width: 100%;
            max-width: min(95vw, 70vh); 
            background: var(--panel-bg);
            border: 4px solid var(--panel-bg);
            border-radius: 12px;
            position: relative;
            transition: all 0.3s ease;
        }

        .tile {
            aspect-ratio: 1/1;
            background: var(--tile-bg);
            color: #1e293b;
            display: flex; flex-direction: column; align-items: center;
            border-radius: 3px;
            position: relative;
            overflow: visible;
        }
        .tile.owned { border: 2px solid transparent; }
        
        .street-bar { width: 100%; height: 4px; flex-shrink: 0; opacity: 0.85; border-radius: 2px 2px 0 0; }
        .tile-idx { position: absolute; top: 1px; left: 2px; font-size: 8px; color: #94a3b8; font-weight: bold; opacity: 0.5; }
        .level-stars { position: absolute; top: 2px; right: 2px; font-size: 8px; color: #eab308; display: flex; gap: 0; z-index: 5; text-shadow: 0 1px 1px rgba(0,0,0,0.1); }

        /* ÂÜÖÂÆπÂìçÂ∫îÂºè */
        .tile-content { flex: 1; width: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 2px; }
        .tile-icon-div { font-size: 16px; line-height: 1; margin-bottom: 2px; transition: all 0.3s; }
        .tile-name-div { font-weight: 700; width: 100%; text-align: center; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; font-size: 10px; margin-top: 1px; }
        .tile-price-div { background-color: #f1f5f9; border-radius: 4px; padding: 1px 4px; margin-top: 2px; font-family: monospace; color: #64748b; font-size: 9px; line-height: 1; }
        .tile-owner-div { margin-top: 2px; padding: 2px 6px; border-radius: 4px; color: white; font-weight: 700; font-size: 9px; box-shadow: 0 1px 2px rgba(0,0,0,0.1); line-height: 1; max-width: 95%; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        /* Ë∑ØÂæÑÁÆ≠Â§¥ */
        .path-arrow { position: absolute; color: rgba(148, 163, 184, 0.4); font-size: 10px; pointer-events: none; z-index: 0; }
        .arrow-right { right: -6px; top: 50%; transform: translateY(-50%); }
        .arrow-left { left: -6px; top: 50%; transform: translateY(-50%); }
        .arrow-down { bottom: -8px; left: 50%; transform: translateX(-50%); font-size: 12px; }
        .return-start { position: absolute; bottom: 2px; width: 100%; text-align: center; font-size: 7px; color: #ef4444; font-weight: bold; background: rgba(255,255,255,0.9); pointer-events: none; z-index: 10; }

        /* --- Ê£ãÂ≠ê --- */
        .token { position: absolute; z-index: 50; display: flex; align-items: center; justify-content: center; transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1); pointer-events: none; }
        .token-body { width: 22px; height: 22px; border-radius: 50%; border: 2px solid #fff; box-shadow: 0 4px 8px rgba(0,0,0,0.4); display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 10px; background-size: cover; }
        .token-body.hopping { animation: jump 0.3s infinite alternate; }
        @keyframes jump { 0% { transform: translateY(0); } 100% { transform: translateY(-14px) scale(1.1); } }

        /* ÊµÆÂä®ÊñáÂ≠ó */
        .float-text { position: absolute; top: -20px; left: 50%; transform: translateX(-50%); font-weight: 900; font-size: 14px; text-shadow: 0 2px 4px rgba(0,0,0,0.5); animation: floatUp 1.5s forwards; pointer-events: none; z-index: 100; white-space: nowrap; }
        @keyframes floatUp { 0% { opacity: 1; transform: translate(-50%, 0) scale(1); } 100% { opacity: 0; transform: translate(-50%, -40px) scale(1.2); } }

        /* --- HUD --- */
        .mobile-hud { position: absolute; bottom: 0; left: 0; right: 0; background: rgba(30, 41, 59, 0.95); backdrop-filter: blur(12px); border-top: 1px solid rgba(255,255,255,0.1); padding: 10px 15px; padding-bottom: max(10px, env(safe-area-inset-bottom)); display: flex; flex-direction: column; gap: 10px; z-index: 60; box-shadow: 0 -4px 20px rgba(0,0,0,0.3); }
        .desktop-hud { height: 100%; background: var(--panel-bg); border-radius: 16px; padding: 20px; display: flex; flex-direction: column; gap: 20px; color: white; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }

        .dice-btn { background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%); border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 24px; font-weight: 900; color: #0f172a; box-shadow: 0 4px 0 #94a3b8, 0 5px 10px rgba(0,0,0,0.2); transition: all 0.1s; cursor: pointer; }
        .dice-btn:active { transform: translateY(4px); box-shadow: 0 0 0 #94a3b8, inset 0 2px 5px rgba(0,0,0,0.1); }
        .dice-rolling { animation: dice-wobble 0.4s ease-in-out infinite; }
        @keyframes dice-wobble { 0%, 100% { transform: rotate(0deg) scale(1); } 25% { transform: rotate(-15deg) scale(1.1); } 75% { transform: rotate(15deg) scale(1.1); } }

        .player-card { background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; padding: 8px; display: flex; align-items: center; gap: 10px; cursor: pointer; transition: all 0.2s; }
        .player-card.active { background: rgba(59, 130, 246, 0.2); border-color: #3b82f6; }
        .player-card.bankrupt { opacity: 0.4; filter: grayscale(1); }

        .no-scrollbar::-webkit-scrollbar { display: none; }
        .modal-bg { background: rgba(0,0,0,0.85); backdrop-filter: blur(4px); }
        .modal-content { animation: modalPop 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        @keyframes modalPop { from { opacity: 0; transform: scale(0.95) translateY(10px); } to { opacity: 1; transform: scale(1) translateY(0); } }

        @media (min-width: 600px) {
            .token-body { width: 30px; height: 30px; font-size: 14px; border-width: 3px; }
            .tile-icon-div { font-size: 28px; margin-bottom: 4px; }
            .tile-name-div { font-size: 13px; }
            .tile-price-div { font-size: 11px; padding: 2px 6px; }
            .tile-owner-div { font-size: 11px; padding: 2px 8px; }
            .path-arrow { font-size: 14px; }
            .arrow-right, .arrow-left { right: -8px; left: -8px; }
            .arrow-down { font-size: 16px; bottom: -10px; }
            .return-start { font-size: 10px; }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- ÈùôÊÄÅÊï∞ÊçÆ (SVGÂõæÊ†á) ---
        const ICONS = {
            car: <svg viewBox="0 0 24 24" fill="currentColor" width="100%" height="100%"><path d="M18.92 6.01C18.72 5.42 18.16 5 17.5 5h-11c-.66 0-1.21.42-1.42 1.01L3 12v8c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-1h12v1c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-8l-2.08-5.99zM6.5 16c-.83 0-1.5-.67-1.5-1.5S5.67 13 6.5 13s1.5.67 1.5 1.5S7.33 16 6.5 16zm11 0c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5zM5 11l1.5-4.5h11L19 11H5z"/></svg>,
            ship: <svg viewBox="0 0 24 24" fill="currentColor" width="100%" height="100%"><path d="M20 21c-1.39 0-2.78-.47-4-1.32-2.44 1.71-5.56 1.71-8 0C6.78 20.53 5.39 21 4 21H2v2h2c1.38 0 2.74-.35 4-.99 2.52 1.29 5.48 1.29 8 0 1.26.65 2.62.99 4 .99h2v-2h-2zM3.95 19H4c1.6 0 3.02-.88 4-2 .98 1.12 2.4 2 4 2s3.02-.88 4-2c.98 1.12 2.4 2 4 2h.05l1.89-6.68c.08-.26.06-.54-.06-.78s-.34-.42-.6-.5L20 10.62V6c0-1.1-.9-2-2-2h-3V1H9v3H6c-1.1 0-2 .9-2 2v4.62l-1.29.42c-.26.08-.48.26-.6.5s-.15.52-.06.78L3.95 19zM6 6h12v3.97L12 8 6 9.97V6z"/></svg>,
            star: <svg viewBox="0 0 24 24" fill="currentColor" width="100%" height="100%"><path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"/></svg>,
            crown: <svg viewBox="0 0 24 24" fill="currentColor" width="100%" height="100%"><path d="M5 16L3 5l5.5 5L12 4l3.5 6L21 5l-2 11h-14zm14 3c0 .6-.4 1-1 1H6c-.6 0-1-.4-1-1v-1h14v1z"/></svg>,
            robot: <svg viewBox="0 0 24 24" fill="currentColor" width="100%" height="100%"><path d="M12 2a2 2 0 0 1 2 2c0 .74-.4 1.39-1 1.73V7h1a7 7 0 0 1 7 7h1a1 1 0 0 1 1 1v3a1 1 0 0 1-1 1h-1v1a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-1H2a1 1 0 0 1-1-1v-3a1 1 0 0 1 1-1h1a7 7 0 0 1 7-7h1V5.73c-.6-.34-1-.99-1-1.73a2 2 0 0 1 2-2M7.5 13A2.5 2.5 0 0 0 5 15.5A2.5 2.5 0 0 0 7.5 18a2.5 2.5 0 0 0 2.5-2.5A2.5 2.5 0 0 0 7.5 13m9 0a2.5 2.5 0 0 0-2.5 2.5a2.5 2.5 0 0 0 2.5 2.5a2.5 2.5 0 0 0 2.5-2.5z"/></svg>,
            leaf: <svg viewBox="0 0 24 24" fill="currentColor" width="100%" height="100%"><path d="M17 8C8 10 5.9 16.17 3.82 21.34L5.71 22l1-2.3A4.49 4.49 0 0 0 8 20C19 20 22 3 22 3c-1 2-8 2.25-13 3.25S2 11.5 2 13.5s1.75 3.75 1.75 3.75C7 8 17 8 17 8z"/></svg>,
            paw: <svg viewBox="0 0 24 24" fill="currentColor" width="100%" height="100%"><path d="M14 11.5a2.5 2.5 0 0 1-5 0 2.5 2.5 0 0 1 5 0zm3.5-3a2.5 2.5 0 0 1-5 0 2.5 2.5 0 0 1 5 0zm-11 0a2.5 2.5 0 0 1-5 0 2.5 2.5 0 0 1 5 0zm7 7.5a6 6 0 0 1-6-6 6 6 0 0 1 12 0 6 6 0 0 1-6 6z"/></svg>,
            mask: <svg viewBox="0 0 24 24" fill="currentColor" width="100%" height="100%"><path d="M2 9c0 4.97 4.03 9 9 9h2c4.97 0 9-4.03 9-9s-4.03-9-9-9-9 4.03-9 9zm10 4.5c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2zm-6.5-2c0-1.1.9-2 2-2s2 .9 2 2-.9 2-2 2-2 .9-2 2zm6.5 6c-2.67 0-5.06-1.28-6.5-3.25.96-.3 1.99-.48 3.06-.52.57 1.03 1.66 1.77 2.94 1.77s2.37-.74 2.94-1.77c1.07.04 2.1.22 3.06.52-1.44 1.97-3.83 3.25-6.5 3.25z"/></svg>,
            smile: <svg viewBox="0 0 24 24" fill="currentColor" width="100%" height="100%"><path d="M11.99 2C6.47 2 2 6.48 2 12s4.47 10 9.99 10C17.52 22 22 17.52 22 12S17.52 2 11.99 2zM12 20c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8zm3.5-9c.83 0 1.5-.67 1.5-1.5S16.33 8 15.5 8 14 8.67 14 9.5s.67 1.5 1.5 1.5zm-7 0c.83 0 1.5-.67 1.5-1.5S9.33 8 8.5 8 7 8.67 7 9.5 7.67 11 8.5 11zm3.5 6.5c2.33 0 4.31-1.46 5.11-3.5H6.89c.8 2.04 2.78 3.5 5.11 3.5z"/></svg>
        };

        const CHARACTER_ROSTER = [
            { id: 'huang', name: "ÈªÑÂ∞èË∂ä", color: "#eab308", bgLight: "#fef9c3", icon: ICONS.star, desc: "Âπ∏Ëøê‰πãÊòü" },
            { id: 'king', name: "Â§öÈáëÁéã", color: "#f59e0b", bgLight: "#fef3c7", icon: ICONS.crown, desc: "ÂØåÂèØÊïåÂõΩ" },
            { id: 'tech', name: "ÁßëÊäÄ‰æ†", color: "#3b82f6", bgLight: "#dbeafe", icon: ICONS.robot, desc: "Êô∫ÊÖßË∂ÖÁæ§" },
            { id: 'racer', name: "ÊûÅÈÄüÂÆ¢", color: "#ef4444", bgLight: "#fee2e2", icon: ICONS.car, desc: "È£éÈ©∞ÁîµÊé£" },
            { id: 'druid', name: "Ëá™ÁÑ∂ÁÅµ", color: "#10b981", bgLight: "#d1fae5", icon: ICONS.leaf, desc: "ÁîüÁîü‰∏çÊÅØ" },
            { id: 'pinky', name: "Á≤âÁ∫¢Ë±π", color: "#ec4899", bgLight: "#fce7f3", icon: ICONS.paw, desc: "‰ºòÈõÖÊïèÊç∑" },
            { id: 'sailor', name: "Ëà™Êµ∑ÂÆ∂", color: "#06b6d4", bgLight: "#cffafe", icon: ICONS.ship, desc: "ÂæÅÊúçÊµ∑Ê¥ã" },
            { id: 'ninja', name: "ÊöóÂ§úË°å", color: "#6366f1", bgLight: "#e0e7ff", icon: ICONS.mask, desc: "Á•ûÂá∫È¨ºÊ≤°" },
        ];

        const BUSINESS_DATA = [
            {n:"ÁÉßÁÉ§Êëä",i:"üç¢"}, {n:"Êä•Âàä‰∫≠",i:"üì∞"}, {n:"Â•∂Ëå∂Â∫ó",i:"üßã"}, {n:"‰æøÂà©Â∫ó",i:"üè™"}, {n:"Ê∞¥ÊûúÊëä",i:"üçé"}, 
            {n:"ÂíñÂï°È¶Ü",i:"‚òï"}, {n:"ÂÅ•Ë∫´Êàø",i:"üèãÔ∏è"}, {n:"ÁΩëÂêß",i:"üéÆ"}, {n:"ÁÅ´ÈîÖÂ∫ó",i:"ü•ò"}, {n:"‰π¶Â∫ó",i:"üìö"},
            {n:"ÁîµÂΩ±Èô¢",i:"üé¨"}, {n:"ÈÖíÂ∫ó",i:"üè®"}, {n:"Ê∏∏‰πêÂõ≠",i:"üé°"}, {n:"Èì∂Ë°å",i:"üè¶"}, {n:"ÁßëÊäÄÂõ≠",i:"üß¨"}
        ];

        function App() {
            const [stage, setStage] = useState('menu');
            const [settings, setSettings] = useState({ playerCount: 2, mapSize: 'normal' });
            const [selectedChars, setSelectedChars] = useState({});
            
            const [tiles, setTiles] = useState([]);
            const [gridConfig, setGridConfig] = useState({ cols: 6, rows: 7 });
            
            const [players, setPlayers] = useState([]);
            const [turn, setTurn] = useState(0);
            const [dice, setDice] = useState(1);
            const [isRolling, setIsRolling] = useState(false);
            const [movingPlayerId, setMovingPlayerId] = useState(null);
            const [modal, setModal] = useState(null);
            const [logs, setLogs] = useState(["Ê¨¢ËøéÊù•Âà∞Â§ßÂØåÁøÅÔºÅ"]);
            const [floatTexts, setFloatTexts] = useState([]);
            const [assetTab, setAssetTab] = useState('stats');

            const handleCharSelect = (idx, charId) => {
                if (Object.values(selectedChars).includes(charId) && selectedChars[idx] !== charId) return;
                setSelectedChars(prev => ({...prev, [idx]: charId}));
            };

            const confirmSelection = () => {
                if (Object.keys(selectedChars).length < settings.playerCount) { alert("ËØ∑‰∏∫ÊâÄÊúâÁé©ÂÆ∂ÈÄâÊã©ËßíËâ≤ÔºÅ"); return; }
                startGame();
            };

            const startGame = () => {
                const cols = 6;
                let rows = 7; 
                if(settings.mapSize === 'large') rows = 9;
                if(settings.mapSize === 'epic') rows = 12;

                const total = cols * rows;
                const newTiles = createSnakeMap(total);
                
                setGridConfig({ cols, rows });
                setTiles(newTiles);
                
                const initP = Array.from({ length: settings.playerCount }, (_, i) => {
                    const charData = CHARACTER_ROSTER.find(c => c.id === selectedChars[i]);
                    return {
                        id: i, name: charData.name, color: charData.color, bgLight: charData.bgLight, icon: charData.icon,
                        money: 1500, pos: 0, inJail: false, isBankrupt: false,
                        stats: { income: { rent: 0, salary: 0, other: 0 }, expense: { buy: 0, rent: 0, tax: 0 } }
                    };
                });
                setPlayers(initP);
                setTurn(0);
                setLogs([`Âú∞ÂõæÁîüÊàêÂÆåÊØï (${total}Ê†º)! ÂàùÂßãËµÑÈáë $1500`]);
                setStage('playing');
            };

            const createSnakeMap = (total) => {
                const arr = [];
                const colors = ['orange', 'yellow', 'green', 'cyan', 'blue', 'purple', 'pink', 'rose', 'red', 'teal'];
                let colorIdx = 0;
                for (let i = 0; i < total; i++) {
                    if (i === 0) { arr.push({ id: i, type: 'start', name: 'Ëµ∑ÁÇπ', icon: 'üèÅ', color: 'slate' }); continue; }
                    const rand = Math.random();
                    if (i % 6 === 0) {
                        if (rand > 0.7) arr.push({ id: i, type: 'chance', name: 'Êú∫‰ºö', icon: '‚ùì', color: 'amber' });
                        else if (rand > 0.4) arr.push({ id: i, type: 'tax', name: 'ÂõΩÁ®éÂ±Ä', icon: 'üí∏', color: 'stone', amount: 200 });
                        else arr.push({ id: i, type: 'hospital', name: 'ÂåªÈô¢', icon: 'üè•', color: 'red', amount: 100 });
                        continue;
                    }
                    if (i === Math.floor(total * 0.25)) { arr.push({ id: i, type: 'jail', name: 'Êé¢Áõë', icon: '‚õìÔ∏è', color: 'slate' }); continue; }
                    if (i === Math.floor(total * 0.5)) { arr.push({ id: i, type: 'parking', name: '‰ºëÊÅØÂå∫', icon: 'üí§', color: 'slate' }); continue; }
                    if (i === Math.floor(total * 0.75)) { arr.push({ id: i, type: 'casino', name: 'ËµåÂú∫', icon: 'üé∞', color: 'violet' }); continue; }
                    if (i === total - 3) { arr.push({ id: i, type: 'gotojail', name: 'Ë¢´Êçï', icon: 'üëÆ', color: 'slate' }); continue; }
                    const biz = BUSINESS_DATA[i % BUSINESS_DATA.length];
                    let price = 60 + (i * 5);
                    price = Math.ceil(price / 10) * 10;
                    if (i > 0 && i % 4 === 0) colorIdx = (colorIdx + 1) % colors.length;
                    arr.push({ id: i, type: 'prop', name: biz.n, icon: biz.i, color: colors[colorIdx % colors.length], price: price, rent: Math.floor(price * 0.15), level: 0, owner: null });
                }
                return arr;
            };

            const rollDice = async () => {
                if (isRolling || movingPlayerId !== null || modal) return;
                setIsRolling(true);
                for(let i=0; i<8; i++) { await new Promise(r => setTimeout(r, 60)); setDice(Math.floor(Math.random()*6)+1); }
                const val = Math.floor(Math.random()*6)+1;
                setDice(val);
                setIsRolling(false);
                handleMove(turn, val);
            };

            const handleMove = async (pId, steps) => {
                setMovingPlayerId(pId);
                const player = players[pId];
                if (player.inJail) {
                    if (steps >= 4) { setLogs(p=>["Ë∂äÁã±ÊàêÂäüÔºÅ", ...p]); updatePlayer(pId, { inJail: false }); } 
                    else { setLogs(p=>["Ë∂äÁã±Â§±Ë¥•...", ...p]); setTimeout(() => { setMovingPlayerId(null); nextTurn(); }, 1000); return; }
                }
                let curPos = player.pos;
                for (let i = 0; i < steps; i++) {
                    curPos = (curPos + 1) % tiles.length;
                    updatePlayer(pId, { pos: curPos });
                    await new Promise(r => setTimeout(r, 200));
                }
                if (player.pos + steps >= tiles.length && !player.inJail) {
                    setLogs(p=>["ÁªèËøáËµ∑ÁÇπ +$200", ...p]); transfer(null, pId, 200, 'salary');
                }
                setMovingPlayerId(null);
                setTimeout(() => resolveTile(curPos, pId), 300);
            };

            const resolveTile = (pos, pId) => {
                const tile = tiles[pos];
                const player = players[pId];
                if (tile.type === 'prop') {
                    if (tile.owner === null) {
                        if (player.money >= tile.price) setModal({ type: 'buy', tile });
                        else { setLogs(p=>["ËµÑÈáë‰∏çË∂≥", ...p]); nextTurn(); }
                    } else if (tile.owner === pId) {
                        if (tile.level < 2) setModal({ type: 'upgrade', tile, cost: Math.floor(tile.price * 0.6) });
                        else { setLogs(p=>["Â∑≤Êª°Á∫ß", ...p]); nextTurn(); }
                    } else {
                        const owner = players[tile.owner];
                        if (!owner.isBankrupt) {
                            const multiplier = tile.level === 0 ? 1 : (tile.level === 1 ? 2 : 4);
                            setModal({ type: 'rent', tile, owner, amount: tile.rent * multiplier });
                        } else { setLogs(p=>["ÂÖçÁßüÈáë", ...p]); nextTurn(); }
                    }
                }
                else if (tile.type === 'chance') { setModal({ type: 'event', ...(Math.random()>0.5 ? {t:"‰∏≠Â•ñ +$200",v:200,g:true} : {t:"‰∏¢Èí± -$100",v:-100,g:false}) }); }
                else if (tile.type === 'casino') setModal({ type: 'casino' });
                else if (tile.type === 'hospital') { setLogs(p=>["ÊîØ‰ªòÂåªÁñóË¥π $100", ...p]); transfer(pId, null, 100, 'tax'); setTimeout(nextTurn, 800); }
                else if (tile.type === 'tax') { setLogs(p=>[`Á∫≥Á®é $${tile.amount}`, ...p]); transfer(pId, null, tile.amount, 'tax'); setTimeout(nextTurn, 800); }
                else if (tile.type === 'gotojail') { setLogs(p=>["Ë¢´Â∏¶Ëµ∞ÔºÅ", ...p]); updatePlayer(pId, { pos: tiles.findIndex(t => t.type === 'jail') || 0, inJail: true }); setTimeout(nextTurn, 1000); }
                else nextTurn();
            };

            const updatePlayer = (id, data) => setPlayers(prev => prev.map(p => p.id === id ? {...p, ...data} : p));
            const updateTile = (id, data) => setTiles(prev => prev.map(t => t.id === id ? {...t, ...data} : t));
            
            const showFloatText = (playerId, text, color) => {
                const id = Date.now() + Math.random();
                const pos = players[playerId].pos;
                setFloatTexts(prev => [...prev, { id, text, color, pos }]);
                setTimeout(() => setFloatTexts(prev => prev.filter(ft => ft.id !== id)), 1500);
            };

            const transfer = (from, to, val, reason) => {
                if (from !== null) showFloatText(from, `-$${val}`, 'text-red-500');
                if (to !== null) showFloatText(to, `+$${val}`, 'text-green-500');
                setPlayers(prev => prev.map(p => {
                    let newP = { ...p };
                    if (from !== null && p.id === from) {
                        if (newP.money < val) {
                            const myAssets = tiles.filter(t => t.owner === p.id).sort((a,b) => a.price - b.price);
                            let recovered = 0, sold = [];
                            for (let asset of myAssets) {
                                if (newP.money + recovered >= val) break;
                                const sell = Math.floor(asset.price * 0.5);
                                recovered += sell; sold.push(asset.id);
                                setLogs(prev => [`üí∏ ÂèòÂçñ ${asset.name}`, ...prev]);
                            }
                            if (sold.length > 0) { setTiles(ts => ts.map(t => sold.includes(t.id) ? { ...t, owner: null, level: 0 } : t)); newP.money += recovered; }
                        }
                        newP.money -= val;
                        if (reason === 'buy') newP.stats.expense.buy += val;
                        if (reason === 'rent') newP.stats.expense.rent += val;
                        if (reason === 'tax') newP.stats.expense.tax += val;
                    }
                    if (to !== null && p.id === to) {
                        newP.money += val;
                        if (reason === 'rent') newP.stats.income.rent += val;
                        if (reason === 'salary') newP.stats.income.salary += val;
                        if (reason === 'other') newP.stats.income.other += val;
                    }
                    return newP;
                }));
            };

            const nextTurn = () => {
                setPlayers(curr => {
                    const nextP = curr.map(p => {
                        if (p.money < 0 && !p.isBankrupt) {
                            setTiles(ts => ts.map(t => t.owner === p.id ? { ...t, owner: null, level: 0 } : t));
                            setLogs(prev => [`üíî ${p.name} Á†¥‰∫ß‰∫ÜÔºÅ`, ...prev]);
                            return { ...p, isBankrupt: true, money: 0 };
                        }
                        return p;
                    });
                    const alive = nextP.filter(p => !p.isBankrupt);
                    if (alive.length === 1) { setStage('gameover'); return nextP; }
                    let next = (turn + 1) % nextP.length;
                    while (nextP[next].isBankrupt) next = (next + 1) % nextP.length;
                    setTurn(next);
                    return nextP;
                });
            };

            const actions = {
                buy: () => { transfer(turn, null, modal.tile.price, 'buy'); updateTile(modal.tile.id, { owner: turn, level: 0 }); setLogs(p=>[`Êî∂Ë¥≠ ${modal.tile.name}`, ...p]); setModal(null); nextTurn(); },
                upgrade: () => { transfer(turn, null, modal.cost, 'buy'); updateTile(modal.tile.id, { level: modal.tile.level + 1 }); setLogs(p=>[`ÂçáÁ∫ß ${modal.tile.name}`, ...p]); setModal(null); nextTurn(); },
                rent: () => { transfer(turn, modal.owner.id, modal.amount, 'rent'); setLogs(p=>[`‰ªòÁßüÈáë $${modal.amount}`, ...p]); setModal(null); nextTurn(); },
                event: () => { if (modal.v > 0) transfer(null, turn, modal.v, 'other'); else transfer(turn, null, Math.abs(modal.v), 'tax'); setModal(null); nextTurn(); },
                casino: () => { setModal(null); setTimeout(() => { const win = Math.random() > 0.5; const amount = 300; if (win) { transfer(null, turn, amount, 'other'); setModal({ type: 'alert', title: "üé∞ Â§ßËé∑ÂÖ®ËÉúÔºÅ", msg: `Ëµ¢Âæó‰∫Ü $${amount}`, color: 'text-green-500' }); } else { transfer(turn, null, amount, 'tax'); setModal({ type: 'alert', title: "üé∞ ÈÅóÊÜæ...", msg: `ËæìÊéâ‰∫Ü $${amount}`, color: 'text-red-500' }); } }, 500); },
                closeAlert: () => { setModal(null); nextTurn(); }
            };

            const getSnakePos = (idx) => {
                const { cols } = gridConfig;
                const row = Math.floor(idx / cols);
                let col = idx % cols;
                if (row % 2 !== 0) col = cols - 1 - col;
                return { col: col + 1, row: row + 1 };
            };

            const getArrowDir = (idx) => {
                if (idx === tiles.length - 1) return null;
                const curr = getSnakePos(idx);
                const next = getSnakePos(idx + 1);
                if (next.col > curr.col) return 'right';
                if (next.col < curr.col) return 'left';
                if (next.row > curr.row) return 'down';
                return null;
            };

            // --- Ê∏≤Êüì ---
            const Controls = () => (
                <>
                    <div className="bg-slate-800/50 rounded-lg p-3 flex-1 overflow-hidden flex flex-col">
                        <h3 className="text-xs font-bold text-slate-400 mb-2 uppercase tracking-wider">ÊúÄÊñ∞Âä®ÊÄÅ</h3>
                        <div className="flex-1 overflow-y-auto no-scrollbar flex flex-col gap-1">
                            {logs.map((l, i) => <div key={i} className={`text-xs ${i===0?'text-white font-bold':'text-slate-400'}`}>{l}</div>)}
                        </div>
                    </div>
                    <div className="flex items-center justify-center gap-4 py-4">
                        <button onClick={rollDice} disabled={isRolling || modal} className={`dice-btn w-24 h-24 text-4xl shadow-xl ${isRolling ? 'dice-rolling' : ''}`}>{dice}</button>
                    </div>
                    <div className="grid grid-cols-2 md:grid-cols-1 gap-2">
                        {players.map(p => (
                            <div key={p.id} onClick={() => {setModal({ type: 'asset', p }); setAssetTab('stats');}} className={`player-card ${turn === p.id ? 'active' : ''} ${p.isBankrupt ? 'bankrupt' : ''}`}>
                                <div className="w-8 h-8 rounded-full flex items-center justify-center text-white" style={{backgroundColor: p.color}}><div style={{width:'16px', height:'16px'}}>{p.icon}</div></div>
                                <div className="flex-1 min-w-0"><div className="text-xs font-bold text-slate-300 flex justify-between"><span>{p.name}</span>{p.inJail && <span className="text-red-500">Áã±</span>}</div><div className="text-sm font-mono font-bold text-green-400">${p.money}</div></div>
                            </div>
                        ))}
                    </div>
                </>
            );

            if (stage === 'menu') return (
                <div className="flex h-full items-center justify-center bg-slate-900 p-6 relative overflow-hidden">
                    <div className="absolute inset-0 opacity-10 bg-[url('https://www.transparenttextures.com/patterns/cubes.png')]"></div>
                    <div className="w-full max-w-sm bg-slate-800/90 backdrop-blur p-8 rounded-3xl border border-slate-700 shadow-2xl text-center relative z-10">
                        <h1 className="text-5xl font-black text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-purple-500 mb-2">Â§ßÂØåÁøÅ</h1>
                        <p className="text-slate-400 text-sm mb-8 font-bold tracking-widest">ÂïÜ‰∏öÂ∏ùÂõΩ ¬∑ Á≠ñÁï•Áâà</p>
                        <div className="space-y-6">
                            <div className="text-left"><label className="text-xs text-slate-500 font-bold mb-2 block">Áé©ÂÆ∂‰∫∫Êï∞</label><div className="flex gap-2">{[2,3,4].map(n => <button key={n} onClick={()=>setSettings({...settings, playerCount:n})} className={`flex-1 py-3 rounded-xl font-bold transition-all ${settings.playerCount===n?'bg-blue-600 text-white shadow-lg':'bg-slate-700 text-slate-400'}`}>{n}‰∫∫</button>)}</div></div>
                            <div className="text-left"><label className="text-xs text-slate-500 font-bold mb-2 block">Âú∞ÂõæÂ§ßÂ∞è</label><div className="grid grid-cols-1 gap-2"><button onClick={()=>setSettings({...settings, mapSize:'normal'})} className={`p-3 rounded-xl border text-left transition-all ${settings.mapSize==='normal'?'border-blue-500 bg-blue-500/10':'border-slate-600 bg-slate-700'}`}><div className="font-bold text-white text-sm">Ê†áÂáÜ (42Ê†º)</div></button><button onClick={()=>setSettings({...settings, mapSize:'large'})} className={`p-3 rounded-xl border text-left transition-all ${settings.mapSize==='large'?'border-purple-500 bg-purple-500/10':'border-slate-600 bg-slate-700'}`}><div className="font-bold text-white text-sm">Âä†Èïø (54Ê†º)</div></button></div></div>
                        </div>
                        <button onClick={()=>setStage('char_select')} className="w-full mt-8 py-4 bg-gradient-to-r from-blue-600 to-indigo-600 rounded-xl font-bold text-white shadow-xl hover:scale-105 transition-transform">‰∏ã‰∏ÄÊ≠•ÔºöÈÄâÊã©ËßíËâ≤</button>
                    </div>
                </div>
            );

            if (stage === 'char_select') return (
                <div className="flex h-full flex-col bg-slate-900 p-6 overflow-hidden">
                    <h2 className="text-2xl font-bold text-white mb-6 text-center">ÈÄâÊã©ËßíËâ≤ÂΩ¢Ë±°</h2>
                    <div className="flex-1 overflow-y-auto no-scrollbar">
                        <div className="grid grid-cols-2 gap-4">
                            {Array.from({length: settings.playerCount}).map((_, idx) => (
                                <div key={idx} className="bg-slate-800 rounded-xl p-4 border border-slate-700">
                                    <div className="text-sm text-slate-400 mb-2 font-bold">Áé©ÂÆ∂ {idx + 1}</div>
                                    <div className="grid grid-cols-4 gap-2">
                                        {CHARACTER_ROSTER.map(char => {
                                            const isSelected = selectedChars[idx] === char.id;
                                            const isTaken = Object.values(selectedChars).includes(char.id) && !isSelected;
                                            return (
                                                <button key={char.id} onClick={() => handleCharSelect(idx, char.id)} disabled={isTaken}
                                                    className={`aspect-square rounded-lg flex items-center justify-center transition-all ${isSelected ? 'ring-2 ring-white scale-110 z-10' : ''} ${isTaken ? 'opacity-20 grayscale' : 'hover:bg-slate-700'}`}
                                                    style={{backgroundColor: isTaken ? 'transparent' : char.color}}
                                                    title={char.name}
                                                >
                                                    <div style={{width:'20px', height:'20px', color:'white'}}>{char.icon}</div>
                                                </button>
                                            );
                                        })}
                                    </div>
                                    <div className="mt-3 text-center h-5 text-sm font-bold text-white">{selectedChars[idx] ? CHARACTER_ROSTER.find(c=>c.id===selectedChars[idx]).name : <span className="text-slate-500">ËØ∑ÈÄâÊã©...</span>}</div>
                                </div>
                            ))}
                        </div>
                    </div>
                    <button onClick={confirmSelection} className="w-full mt-4 py-4 bg-green-600 rounded-xl font-bold text-white shadow-xl">ÂºÄÂßãÊ∏∏Êàè</button>
                </div>
            );

            if (stage === 'gameover') {
                const winner = players.find(p=>!p.isBankrupt) || players[0];
                return (
                    <div className="flex h-full items-center justify-center bg-slate-900 text-white relative">
                        <div className="text-center z-10"><div className="text-8xl mb-4 animate-bounce">üèÜ</div><h2 className="text-2xl font-bold mb-2 text-slate-400">ÂïÜ‰∏öÂ§ß‰∫®ËØûÁîü</h2><div className="text-6xl font-black mb-12" style={{color: winner.color}}>{winner.name}</div><button onClick={()=>window.location.reload()} className="px-10 py-4 bg-slate-800 border border-slate-600 rounded-full font-bold hover:bg-slate-700 transition-colors">ËøîÂõûËèúÂçï</button></div>
                    </div>
                );
            }

            const currentPlayer = players[turn];

            return (
                <div className="app-container">
                    <div className="board-section">
                        <div className="board-grid" style={{ gridTemplateColumns: `repeat(${gridConfig.cols}, 1fr)` }}>
                            {tiles.map((t, i) => {
                                const pos = getSnakePos(i);
                                const owner = t.owner !== null ? players[t.owner] : null;
                                const dir = getArrowDir(i);
                                return (
                                    <div key={i} className={`tile ${owner ? 'owned' : ''}`} style={{ gridColumn: pos.col, gridRow: pos.row, backgroundColor: owner ? owner.bgLight : (t.type !== 'prop' ? '#f1f5f9' : '#ffffff'), borderColor: owner ? owner.color : 'transparent', borderWidth: owner ? '2px' : '0' }}>
                                        <div className={`street-bar ${t.color === 'slate' ? 'bg-slate-400' : `bg-${t.color}-400`}`} style={{backgroundColor: t.color === 'slate' ? null : null }}></div>
                                        <div className="tile-idx">{i}</div>
                                        {dir === 'right' && <div className="path-arrow arrow-right">‚ûú</div>}
                                        {dir === 'left' && <div className="path-arrow arrow-left">‚¨Ö</div>}
                                        {dir === 'down' && <div className="path-arrow arrow-down">‚¨á</div>}
                                        {i === tiles.length - 1 && <div className="return-start">‚Ü∫ ÂõûËµ∑ÁÇπ</div>}
                                        {t.level > 0 && <div className="level-stars">{[...Array(t.level)].map((_,k)=><span key={k}>{t.level===2?'üëë':'‚≠ê'}</span>)}</div>}
                                        <div className="tile-content">
                                            <div className="tile-icon-div">{t.icon}</div>
                                            <div className="tile-name-div">{t.name}</div>
                                            {t.type==='prop' && !owner && <div className="tile-price-div">${t.price}</div>}
                                            {owner && <div className="tile-owner-div" style={{backgroundColor: owner.color}}>{owner.name}</div>}
                                        </div>
                                    </div>
                                );
                            })}
                            {players.map((p, idx) => {
                                if (p.isBankrupt) return null;
                                const pos = getSnakePos(p.pos);
                                const isMoving = movingPlayerId === idx;
                                const stackX = (idx % 2 === 0 ? -1 : 1) * 3;
                                const stackY = (idx < 2 ? -1 : 1) * 3;
                                return (
                                    <div key={idx} className="token" style={{ gridColumn: pos.col, gridRow: pos.row }}>
                                        <div style={{transform: `translate(${stackX}px, ${stackY}px)`}}>
                                            <div className={`token-body ${isMoving ? 'hopping' : ''}`} style={{backgroundColor: p.color}}><div style={{width:'12px', height:'12px'}}>{p.icon}</div></div>
                                        </div>
                                    </div>
                                );
                            })}
                            {floatTexts.map(ft => {
                                const pos = getSnakePos(ft.pos);
                                return <div key={ft.id} className="token" style={{ gridColumn: pos.col, gridRow: pos.row, zIndex: 100 }}><div className={`float-text ${ft.color}`}>{ft.text}</div></div>
                            })}
                        </div>
                    </div>

                    <div className="controls-section desktop-hud">
                        <div className="flex items-center gap-3 mb-4 border-b border-slate-700 pb-4"><div className="text-4xl">üé≤</div><div><h2 className="font-bold text-xl">ÊéßÂà∂Âè∞</h2><div className="text-xs text-slate-400">ÂõûÂêà: {currentPlayer.name}</div></div></div>
                        <Controls />
                    </div>

                    <div className="mobile-hud md:hidden">
                        <div className="flex justify-between items-end">
                            <div className="flex-1 mr-4 overflow-hidden"><div className="text-xs text-slate-400 mb-1">Êó•Âøó</div><div className="text-sm text-yellow-400 font-bold truncate">{logs[0]}</div></div>
                            <button onClick={rollDice} disabled={isRolling || modal} className={`dice-btn w-16 h-16 shrink-0 ${isRolling ? 'dice-rolling' : ''}`}>{dice}</button>
                        </div>
                        <div className="flex gap-2 overflow-x-auto no-scrollbar pt-2 border-t border-slate-700">
                            {players.map(p => (
                                <div key={p.id} onClick={() => {setModal({ type: 'asset', p }); setAssetTab('stats');}} className={`shrink-0 w-20 bg-slate-800 rounded p-2 border border-slate-700 flex flex-col items-center gap-1 ${p.isBankrupt?'opacity-30':''}`}>
                                    <div className="w-6 h-6 rounded-full flex items-center justify-center text-white text-xs" style={{backgroundColor: p.color}}><div style={{width:'12px', height:'12px'}}>{p.icon}</div></div>
                                    <div className="text-xs font-mono text-green-400">${p.money}</div>
                                </div>
                            ))}
                        </div>
                    </div>

                    {modal && (
                        <div className="fixed inset-0 z-[100] flex items-center justify-center modal-bg p-4 modal-content">
                            {modal.type !== 'asset' && (
                                <div className="bg-white w-full max-w-sm rounded-2xl p-6 text-center text-slate-900 shadow-2xl relative overflow-hidden">
                                    <div className="absolute top-0 left-0 right-0 h-2 bg-gradient-to-r from-blue-500 to-purple-600"></div>
                                    {modal.type === 'buy' && (
                                        <>
                                            <div className="text-5xl mb-3">{modal.tile.icon}</div>
                                            <h3 className="text-2xl font-black mb-1">{modal.tile.name}</h3>
                                            <p className="text-slate-500 mb-6 font-mono text-lg">‰ª∑Ê†º ${modal.tile.price}</p>
                                            <div className="flex gap-3">
                                                <button onClick={()=>{setModal(null);nextTurn()}} className="flex-1 py-3 bg-slate-100 rounded-xl font-bold text-slate-600">ÊîæÂºÉ</button>
                                                <button onClick={actions.buy} className="flex-1 py-3 bg-blue-600 text-white rounded-xl font-bold shadow-lg shadow-blue-200">Ë¥≠‰π∞</button>
                                            </div>
                                        </>
                                    )}
                                    {modal.type === 'rent' && (
                                        <>
                                            <div className="text-5xl mb-2">üí∏</div>
                                            <h3 className="text-xl font-bold mb-1">ÊîØ‰ªòÁßüÈáë</h3>
                                            <p className="text-slate-500 mb-6">Êàø‰∏ú: <span className="font-bold" style={{color:modal.owner.color}}>{modal.owner.name}</span></p>
                                            <div className="text-4xl font-black text-red-500 mb-8">-${modal.amount}</div>
                                            <button onClick={actions.rent} className="w-full py-3 bg-slate-800 text-white rounded-xl font-bold">ÊîØ‰ªò</button>
                                        </>
                                    )}
                                    {modal.type === 'event' && (
                                        <>
                                            <div className="text-5xl mb-4">{modal.good?'üéÅ':'‚ö°'}</div>
                                            <h3 className="text-xl font-bold mb-4">{modal.t}</h3>
                                            <button onClick={actions.event} className="w-full py-3 bg-slate-800 text-white rounded-xl font-bold">Á°ÆÂÆö</button>
                                        </>
                                    )}
                                    {modal.type === 'upgrade' && (
                                        <>
                                            <div className="text-5xl mb-3">üèóÔ∏è</div>
                                            <h3 className="text-xl font-bold mb-2">‰∫ß‰∏öÂçáÁ∫ß</h3>
                                            <p className="text-green-600 font-bold text-xl mb-6">Ëä±Ë¥π ${modal.cost}</p>
                                            <div className="flex gap-3">
                                                <button onClick={()=>{setModal(null);nextTurn()}} className="flex-1 py-3 bg-slate-100 rounded-xl font-bold text-slate-500">Ë∑≥Ëøá</button>
                                                <button onClick={actions.upgrade} className="flex-1 py-3 bg-yellow-500 text-white rounded-xl font-bold shadow">ÂçáÁ∫ß</button>
                                            </div>
                                        </>
                                    )}
                                    {modal.type === 'casino' && (
                                        <>
                                            <div className="text-5xl mb-3">üé∞</div>
                                            <h3 className="text-2xl font-bold mb-2">ÁöáÂÆ∂ËµåÂú∫</h3>
                                            <p className="text-slate-500 mb-6">‰∏ãÊ≥® $300ÔºåËµ¢‰∫ÜÁøªÂÄçÔºÅ</p>
                                            <div className="flex gap-3">
                                                <button onClick={()=>{setModal(null);nextTurn()}} className="flex-1 py-3 bg-slate-100 rounded-xl font-bold">Ë∑ØËøá</button>
                                                <button onClick={actions.casino} className="flex-1 py-3 bg-purple-600 text-white rounded-xl font-bold shadow">‰∏ãÊ≥®</button>
                                            </div>
                                        </>
                                    )}
                                    {modal.type === 'alert' && (
                                        <>
                                            <h3 className="text-2xl font-black mb-2">{modal.title}</h3>
                                            <p className={`text-lg font-bold mb-6 ${modal.color}`}>{modal.msg}</p>
                                            <button onClick={actions.closeAlert} className="w-full py-3 bg-slate-800 text-white rounded-xl font-bold">ÁªßÁª≠</button>
                                        </>
                                    )}
                                </div>
                            )}
                            {modal.type === 'asset' && (
                                <div className="bg-white w-full max-w-md rounded-2xl p-5 text-slate-900 shadow-2xl flex flex-col max-h-[80vh]">
                                    <div className="flex justify-between items-center mb-4 border-b pb-2">
                                        <div className="flex items-center gap-2">
                                            <div className="w-8 h-8 rounded-full flex items-center justify-center text-white" style={{backgroundColor: modal.p.color}}><div style={{width:'16px', height:'16px'}}>{modal.p.icon}</div></div>
                                            <div><h3 className="font-bold text-lg leading-none">{modal.p.name}</h3><span className="text-xs text-slate-400">ÊÄªËµÑ‰∫ß‰º∞ÂÄº: ${modal.p.money + tiles.filter(t=>t.owner===modal.p.id).reduce((a,b)=>a+b.price,0)}</span></div>
                                        </div>
                                        <button onClick={()=>setModal(null)} className="w-8 h-8 flex items-center justify-center bg-slate-100 rounded-full font-bold">√ó</button>
                                    </div>
                                    <div className="flex bg-slate-100 rounded-xl p-1 mb-4 shrink-0">
                                        <button onClick={()=>setAssetTab('stats')} className={`flex-1 py-2 text-sm font-bold rounded-lg transition-all ${assetTab==='stats'?'bg-white shadow text-blue-600':'text-slate-400'}`}>üìä Ë¥¢Âä°Êä•Ë°®</button>
                                        <button onClick={()=>setAssetTab('props')} className={`flex-1 py-2 text-sm font-bold rounded-lg transition-all ${assetTab==='props'?'bg-white shadow text-blue-600':'text-slate-400'}`}>üè† Âú∞‰∫ßÊ∏ÖÂçï</button>
                                    </div>
                                    {assetTab === 'stats' && (
                                        <div className="flex-1 overflow-y-auto">
                                            <div className="grid grid-cols-2 gap-3 mb-4">
                                                <div className="bg-green-50 p-3 rounded-xl border border-green-100">
                                                    <div className="text-xs font-bold text-green-600 uppercase mb-2 opacity-70">ÊÄªÊî∂ÂÖ•</div>
                                                    <div className="text-xl font-black text-green-700">${modal.p.stats.income.rent + modal.p.stats.income.salary + modal.p.stats.income.other}</div>
                                                    <div className="mt-2 space-y-1">
                                                        <div className="flex justify-between text-xs text-green-800/60"><span>Êî∂Áßü</span><span>{modal.p.stats.income.rent}</span></div>
                                                        <div className="flex justify-between text-xs text-green-800/60"><span>Â∑•ËµÑ</span><span>{modal.p.stats.income.salary}</span></div>
                                                    </div>
                                                </div>
                                                <div className="bg-red-50 p-3 rounded-xl border border-red-100">
                                                    <div className="text-xs font-bold text-red-600 uppercase mb-2 opacity-70">ÊÄªÊîØÂá∫</div>
                                                    <div className="text-xl font-black text-red-700">${modal.p.stats.expense.buy + modal.p.stats.expense.rent + modal.p.stats.expense.tax}</div>
                                                    <div className="mt-2 space-y-1">
                                                        <div className="flex justify-between text-xs text-red-800/60"><span>Ë¥≠Êàø</span><span>{modal.p.stats.expense.buy}</span></div>
                                                        <div className="flex justify-between text-xs text-red-800/60"><span>‰∫§Áßü</span><span>{modal.p.stats.expense.rent}</span></div>
                                                    </div>
                                                </div>
                                            </div>
                                            <div className="bg-slate-50 p-4 rounded-xl border border-slate-200 flex justify-between items-center"><span className="font-bold text-slate-600">ÂΩìÂâçÁé∞ÈáëÊµÅ</span><span className="text-2xl font-mono font-black text-slate-800">${modal.p.money}</span></div>
                                        </div>
                                    )}
                                    {assetTab === 'props' && (
                                        <div className="overflow-y-auto flex-1 space-y-2 custom-scroll">
                                            {tiles.filter(t=>t.owner===modal.p.id).length === 0 ? <div className="flex flex-col items-center justify-center h-40 text-slate-400"><div className="text-4xl mb-2">üï∏Ô∏è</div><div>ÊöÇÊó†ËµÑ‰∫ß</div></div> :
                                                tiles.filter(t=>t.owner===modal.p.id).map(t=>(
                                                    <div key={t.id} className="flex justify-between items-center p-3 bg-white rounded-xl border border-slate-100 shadow-sm">
                                                        <div className="flex items-center gap-3">
                                                            <div className="w-2 h-8 rounded-full" style={{backgroundColor: `var(--color-${t.color}-500)`}}></div>
                                                            <div>
                                                                <div className="font-bold text-slate-800 flex items-center gap-1"><span className="text-lg">{t.icon}</span> {t.name} {t.level>0 && <span className="bg-yellow-100 text-yellow-600 text-[10px] px-1 rounded border border-yellow-200">{t.level===2?'MAX':'LV2'}</span>}</div>
                                                            </div>
                                                        </div>
                                                        <div className="text-right"><div className="text-xs text-slate-400">ÂΩìÂâçÁßüÈáë</div><div className="font-mono font-bold text-blue-600">${t.rent * (t.level==0?1:t.level==1?2:4)}</div></div>
                                                    </div>
                                                ))
                                            }
                                        </div>
                                    )}
                                </div>
                            )}
                        </div>
                    )}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
